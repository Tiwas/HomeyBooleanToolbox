<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boolean Toolbox Formula Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }

        .truth-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .truth-table th {
            background-color: #2d3748;
            padding: 8px;
            border: 1px solid #4a5568;
            font-weight: 600;
        }
        
        .truth-table td {
            padding: 8px;
            border: 1px solid #4a5568;
            text-align: center;
        }
        
        .truth-table tr:nth-child(even) {
            background-color: #2d3748;
        }
        
        .truth-table td.result-true {
            background-color: #38a169;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }
        
        .truth-table td.result-false {
            background-color: #e53e3e;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }

        .expand-button {
            transition: transform 0.3s ease;
        }
        
        .expand-button.expanded {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 space-y-6">
        
        <!-- Header -->
        <div class="flex flex-col items-center text-center">
            <img src="https://tiwas.github.io/HomeyBooleanToolbox/no.tiwas.booleantoolbox/assets/icon.svg" alt="Boolean Toolbox Logo" class="w-20 h-20 mb-4 rounded-lg">
            <h1 class="text-2xl md:text-3xl font-bold text-white">Boolean Toolbox Formula Builder</h1>
            <p class="text-gray-400 mt-1">Build and test your formulas visually</p>
        </div>

        <!-- Number of Inputs -->
        <div class="space-y-2">
            <label for="numInputs" class="font-semibold text-gray-300">Number of Inputs</label>
            <select id="numInputs" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                <option value="2">2 inputs (A, B)</option>
                <option value="3">3 inputs (A, B, C)</option>
                <option value="4">4 inputs (A, B, C, D)</option>
                <option value="5">5 inputs (A, B, C, D, E)</option>
                <option value="6">6 inputs (A, B, C, D, E, F)</option>
                <option value="7">7 inputs (A, B, C, D, E, F, G)</option>
                <option value="8">8 inputs (A, B, C, D, E, F, G, H)</option>
                <option value="9">9 inputs (A, B, C, D, E, F, G, H, I)</option>
                <option value="10">10 inputs (A, B, C, D, E, F, G, H, I, J)</option>
            </select>
        </div>

        <!-- Formula Details -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <h2 class="text-xl font-semibold text-white">Formula Details</h2>
            <div class="space-y-2">
                <label for="formulaId" class="text-sm font-medium text-gray-300">Formula ID</label>
                <input type="text" id="formulaId" value="f1" placeholder="e.g., f1, sensor_check" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
            </div>
            <div class="space-y-2">
                <label for="formulaName" class="text-sm font-medium text-gray-300">Formula Name</label>
                <input type="text" id="formulaName" value="My Formula" placeholder="e.g., Aircon - contact sensors" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
            </div>
        </div>

        <!-- Build Expression -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <h2 class="text-xl font-semibold text-white">Boolean Expression</h2>
            
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Insert Inputs:</label>
                <div id="inputButtons" class="flex gap-2 flex-wrap"></div>
            </div>

            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-300">Insert Operators:</label>
                <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold transition-colors" onclick="insertText(' AND ')">AND</button>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold transition-colors" onclick="insertText(' OR ')">OR</button>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold transition-colors" onclick="insertText(' XOR ')">XOR</button>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold transition-colors" onclick="insertText('NOT ')">NOT</button>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold transition-colors" onclick="insertText('(')">(</button>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold transition-colors" onclick="insertText(')')">)</button>
                </div>
            </div>

            <div class="space-y-2">
                <input type="text" id="expression" placeholder="e.g., A OR B OR (C AND D)" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                <p class="text-xs text-gray-500 mt-2">Operators: AND (*, &, AND), OR (+, |, OR), XOR (^, !=, XOR), NOT (!, NOT)</p>
                <div id="expressionError" class="text-red-400 text-sm font-semibold min-h-[20px]"></div>
            </div>
        </div>

        <!-- Settings -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <h2 class="text-xl font-semibold text-white">Settings</h2>
            <div class="space-y-2">
                <label for="timeout" class="text-sm font-medium text-gray-300">Timeout (seconds, 0 = infinite)</label>
                <input type="number" id="timeout" value="0" min="0" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
            </div>
            <div class="space-y-2">
                <label for="firstImpression" class="text-sm font-medium text-gray-300">First Impression Mode</label>
                <select id="firstImpression" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                    <option value="true">true - Lock inputs at first value (default)</option>
                    <option value="false">false - Reactive mode (re-evaluate on changes)</option>
                </select>
            </div>
            <div class="space-y-2">
                <label for="enabled" class="text-sm font-medium text-gray-300">Enabled</label>
                <select id="enabled" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                    <option value="true">true</option>
                    <option value="false">false</option>
                </select>
            </div>
        </div>

        <!-- Truth Table -->
        <div class="border-t border-gray-700 pt-4">
            <button id="truth-table-toggle" class="w-full flex items-center justify-between p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                <span class="font-semibold text-gray-300">Truth Table</span>
                <svg class="expand-button w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="truth-table-container" class="hidden mt-4 overflow-x-auto">
                <table class="truth-table text-sm">
                    <thead id="truth-table-head"></thead>
                    <tbody id="truth-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Generated JSON -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <h2 class="text-xl font-semibold text-white">Generated JSON</h2>
            <button class="w-full md:w-auto px-6 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-semibold transition-colors" onclick="generateJSON()">âœ¨ Generate JSON</button>
            <div id="jsonOutput" class="p-3 bg-gray-900 rounded-lg text-gray-400 font-mono text-sm min-h-[40px] whitespace-pre overflow-x-auto">[
  {
    "id": "f1",
    "name": "My Formula",
    "expression": "A AND B",
    "enabled": true,
    "timeout": 0,
    "firstImpression": true
  }
]</div>
            <button class="w-full md:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold transition-colors" onclick="copyToClipboard()">ðŸ“‹ Copy to Clipboard</button>
            <div id="copySuccess" class="text-green-400 font-semibold min-h-[20px]"></div>
        </div>

        <!-- Footer Links -->
        <div class="grid grid-cols-[1fr_auto_1fr] items-baseline gap-x-3 pt-4 border-t border-gray-700">
            <a href="https://github.com/Tiwas/HomeyBooleanToolbox" class="text-sm text-gray-500 hover:text-blue-400 transition-colors justify-self-end">
                View&nbsp;on&nbsp;GitHub
            </a>
            <span class="text-gray-600">|</span>
            <a href="https://tiwas.github.io/HomeyBooleanToolbox/" class="text-sm text-gray-500 hover:text-blue-400 transition-colors justify-self-start">
                Homepage
            </a>
        </div>
    </div>

    <script>
        let currentInputs = ['A', 'B'];

        function updateInputButtons() {
            const numInputs = parseInt(document.getElementById('numInputs').value);
            const allInputs = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
            currentInputs = allInputs.slice(0, numInputs);
            
            const container = document.getElementById('inputButtons');
            container.innerHTML = '';
            
            currentInputs.forEach(input => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg font-semibold transition-colors';
                btn.textContent = input;
                btn.onclick = () => insertText(input);
                container.appendChild(btn);
            });
        }

        function insertText(text) {
            const input = document.getElementById('expression');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            
            input.value = value.substring(0, start) + text + value.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + text.length;
        }

        function validateExpression(expression) {
            if (!expression || expression.trim() === '') {
                return { valid: false, error: 'Expression cannot be empty' };
            }

            const validPattern = new RegExp(`^[${currentInputs.join('')}\\s\\(\\)&|\\*\\+\\^!=ANDORXOTandorxot]+$`);
            if (!validPattern.test(expression)) {
                return { 
                    valid: false, 
                    error: `Expression contains invalid characters. Valid inputs: ${currentInputs.join(', ')}` 
                };
            }

            let depth = 0;
            for (const char of expression) {
                if (char === '(') depth++;
                if (char === ')') depth--;
                if (depth < 0) return { valid: false, error: 'Unbalanced parentheses' };
            }
            if (depth !== 0) return { valid: false, error: 'Unbalanced parentheses' };

            return { valid: true };
        }

        function evaluateExpression(expression, values) {
            let evalExpr = expression
                .replace(/\bAND\b|&|\*/gi, '&&')
                .replace(/\bOR\b|\||\+/gi, '||')
                .replace(/\bXOR\b|\^|!=/gi, '!=')
                .replace(/\bNOT\b/gi, '!');

            currentInputs.forEach(input => {
                const regex = new RegExp(`\\b${input}\\b`, 'g');
                evalExpr = evalExpr.replace(regex, values[input]);
            });

            try {
                return !!eval(evalExpr);
            } catch (e) {
                return null;
            }
        }

        function generateTruthTable() {
            const expression = document.getElementById('expression').value;
            const validation = validateExpression(expression);
            
            const errorDiv = document.getElementById('expressionError');
            if (!validation.valid) {
                errorDiv.textContent = validation.error;
                document.getElementById('truth-table-head').innerHTML = '';
                document.getElementById('truth-table-body').innerHTML = '';
                return;
            }
            errorDiv.textContent = '';

            const numInputs = currentInputs.length;
            const numRows = Math.pow(2, numInputs);
            
            // Generate header
            let headerHTML = '<tr>';
            currentInputs.forEach(input => {
                headerHTML += `<th>${input}</th>`;
            });
            headerHTML += '<th>Result</th></tr>';
            document.getElementById('truth-table-head').innerHTML = headerHTML;

            // Generate body
            let bodyHTML = '';
            for (let i = 0; i < numRows; i++) {
                const values = {};
                bodyHTML += '<tr>';
                
                currentInputs.forEach((input, idx) => {
                    const bit = (i >> (numInputs - 1 - idx)) & 1;
                    values[input] = bit === 1;
                    bodyHTML += `<td>${bit === 1 ? 'true' : 'false'}</td>`;
                });

                const result = evaluateExpression(expression, values);
                const resultClass = result ? 'result-true' : 'result-false';
                bodyHTML += `<td class="${resultClass}">${result ? 'TRUE' : 'FALSE'}</td>`;
                bodyHTML += '</tr>';
            }
            document.getElementById('truth-table-body').innerHTML = bodyHTML;
        }

        function generateJSON() {
            const formulaId = document.getElementById('formulaId').value;
            const formulaName = document.getElementById('formulaName').value;
            const expression = document.getElementById('expression').value;
            const timeout = parseInt(document.getElementById('timeout').value);
            const firstImpression = document.getElementById('firstImpression').value === 'true';
            const enabled = document.getElementById('enabled').value === 'true';

            const validation = validateExpression(expression);
            const errorDiv = document.getElementById('expressionError');
            
            if (!validation.valid) {
                errorDiv.textContent = validation.error;
                return;
            }
            errorDiv.textContent = '';

            const formula = {
                id: formulaId,
                name: formulaName,
                expression: expression,
                enabled: enabled,
                timeout: timeout,
                firstImpression: firstImpression
            };

            const json = JSON.stringify([formula], null, 2);
            document.getElementById('jsonOutput').textContent = json;
        }

        function copyToClipboard() {
            const json = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(json).then(() => {
                const successDiv = document.getElementById('copySuccess');
                successDiv.textContent = 'âœ… Copied to clipboard!';
                setTimeout(() => {
                    successDiv.textContent = '';
                }, 3000);
            });
        }

        document.getElementById('truth-table-toggle').addEventListener('click', () => {
            const container = document.getElementById('truth-table-container');
            const isHidden = container.classList.contains('hidden');
            container.classList.toggle('hidden');
            document.querySelector('.expand-button').classList.toggle('expanded');
            
            if (isHidden) {
                generateTruthTable();
            }
        });

        document.getElementById('numInputs').addEventListener('change', updateInputButtons);
        updateInputButtons();
    </script>
</body>
</html>