<!DOCTYPE html>
<html lang="no" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boolean Editor</title>
    <!-- Tailwind CSS er midlertidig fjernet for feilsøking -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Basic styling to make it usable without Tailwind */
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; margin: 0; padding: 2rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        button { background-color: #2563eb; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; }
        button:hover { background-color: #1d4ed8; }
        button:disabled { background-color: #4b5563; cursor: not-allowed; }
        input, textarea { background-color: #374151; border: 1px solid #4b5563; padding: 0.5rem; border-radius: 0.5rem; width: 100%; color: white;}
        #main-content { background-color: #374151; padding: 2rem; border-radius: 1rem; }
    </style>
</head>
<body class="h-full">
    <div id="app" class="max-w-7xl mx-auto">
        
        <header style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1.5rem; border-bottom: 1px solid #4b5563; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                 <img src="https://tiwas.github.io/HomeyBooleanToolbox/no.tiwas.booleantoolbox/assets/icon.svg" alt="Boolean Toolbox Logo" style="width: 4rem; height: 4rem; border-radius: 0.5rem;">
                 <div>
                    <h1 style="font-size: 1.5rem; font-weight: bold; color: white;">Boolean Editor</h1>
                    <p style="color: #9ca3af; margin-top: 0.25rem;">For Homey Boolean Toolbox</p>
                 </div>
            </div>
            <div id="user-info" style="display: none; text-align: right;">
                <p id="user-name" style="font-weight: 600;"></p>
                <p id="homey-name" style="font-size: 0.875rem; color: #9ca3af;"></p>
                <button id="logout-button" style="font-size: 0.875rem; color: #f87171; background: none; padding: 0;">Logg ut</button>
            </div>
        </header>

        <main id="main-content">
            <div id="loader" class="screen active" style="text-align: center; padding: 4rem;">Laster...</div>
            <div id="login-screen" class="screen" style="text-align: center; padding: 4rem;">
                <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Velkommen!</h2>
                <p style="margin-bottom: 1.5rem; color: #d1d5db;">For å fortsette må du logge inn med din Homey-konto.</p>
                <button id="login-button">Logg inn med Homey</button>
            </div>
            <!-- Rest of the UI will be unstyled but functional -->
            <div id="main-menu-screen" class="screen">
                <h3>Hovedmeny</h3>
                <button onclick="app.showScreen('edit-devices-screen')">Rediger eksisterende enheter</button>
                <button onclick="app.showScreen('create-expression-step1-screen')">Lag nytt uttrykk</button>
                <button onclick="app.showScreen('json-import-screen')">Importer fra JSON</button>
            </div>
             <!-- ... other screens will be basic ... -->
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/homey-api/dist/homey-api.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded and parsed. Initializing app...");

        class BooleanToolboxApp {
            CLIENT_ID = null;
            cloudApi = null;
            // ... (rest of the class is the same)

            constructor() {
                console.log("App constructor called.");
                this.init();
            }

            async init() {
                try {
                    console.log("init() started.");
                    const response = await fetch('/.netlify/functions/get-config');
                    console.log("get-config response status:", response.status);
                    if (!response.ok) throw new Error(`Failed to fetch config: ${response.statusText}`);
                    
                    const config = await response.json();
                    if (!config.clientId) throw new Error('Could not get clientId from config.');
                    this.CLIENT_ID = config.clientId;
                    console.log("Client ID fetched successfully.");

                    // Check if AthomCloudAPI is available
                    if (typeof AthomCloudAPI === 'undefined') {
                        throw new Error("AthomCloudAPI script did not load correctly.");
                    }
                    console.log("AthomCloudAPI is defined.");

                    this.cloudApi = new AthomCloudAPI({ clientId: this.CLIENT_ID });
                    this.setupEventListeners();

                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    console.log("URL code parameter:", code);

                    if (code) {
                        await this.handleAuthRedirect(code);
                    } else if (await this.cloudApi.isLoggedIn()) {
                        console.log("User is already logged in.");
                        await this.postLogin();
                    } else {
                        console.log("User is not logged in. Showing login screen.");
                        this.showScreen('login-screen');
                    }
                } catch (error) {
                    console.error("Initialization failed:", error);
                    this.showError("Klarte ikke å starte appen: " + error.message);
                }
            }

            // --- The rest of the class methods are unchanged ---

            setupEventListeners() {
                 document.getElementById('login-button').addEventListener('click', () => this.login());
                 // ... other listeners
            }
             
            async login() {
                 console.log("Login button clicked.");
                 //...
            }

            async handleAuthRedirect(code) {
                console.log("Handling auth redirect with code...");
                this.showScreen('loader');
                try {
                    const response = await fetch('/.netlify/functions/get-token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: code }),
                    });
                    
                    console.log("get-token response status:", response.status);
                    const tokenData = await response.json();
                    if (!response.ok) {
                        throw new Error(tokenData.error || `Server responded with ${response.status}`);
                    }
                    
                    console.log("Token received successfully.");
                    this.cloudApi.setToken(tokenData);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    await this.postLogin();
                } catch (error) {
                    console.error("Auth redirect failed:", error);
                    this.showError('Authentication failed: ' + error.message);
                }
            }
            
            showError(message) {
                console.error("Displaying error:", message);
                this.showScreen('login-screen');
                const loginScreen = document.getElementById('login-screen');
                // Make sure the error is visible even with basic styles
                loginScreen.innerHTML = `<p style="color: #f87171; padding: 1rem; background-color: #7f1d1d;">${message}</p>`;
            }

            showScreen(screenId) {
                console.log("Showing screen:", screenId);
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const screen = document.getElementById(screenId);
                if(screen) screen.classList.add('active');
            }
            // Add the rest of the class methods from your previous version here...
            // (omitted for brevity, they are correct)
        }
        
        // This will now only run after the DOM is ready.
        window.app = new BooleanToolboxApp();
    });
    </script>
</body>
</html>

