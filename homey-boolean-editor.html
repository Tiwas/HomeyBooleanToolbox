<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boolean Editor & Snapshot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1a202c;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .language-selector {
            position: relative;
        }
        .language-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            min-width: 200px;
        }
        .language-dropdown.active {
            display: block;
        }
        .language-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s;
        }
        .language-option:hover {
            background: #f1f5f9;
        }
        .language-option:first-child {
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .language-option:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }
    </style>
    <script src="https://cdn.athom.com/homey-api/3.14.8.js"></script>
    <script>
        // Ensure both libraries are loaded
        window.HomeyLibrariesReady = Promise.all([
            new Promise((resolve) => {
                if (typeof AthomCloudAPI !== 'undefined') {
                    resolve();
                } else {
                    window.addEventListener('load', () => resolve());
                }
            }),
            new Promise((resolve) => {
                const checkHomeyAPI = () => {
                    if (typeof HomeyAPI !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(checkHomeyAPI, 100);
                    }
                };
                checkHomeyAPI();
            })
        ]);
    </script>
</head>
<body class="h-full">
    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto">
        
        <header class="flex flex-col md:flex-row justify-between items-center pb-6 border-b border-gray-200 mb-6">
            <div class="flex items-center space-x-4">
                 <img src="https://tiwas.github.io/HomeyBooleanToolbox/no.tiwas.booleantoolbox/assets/icon.svg" alt="Boolean Toolbox Logo" class="w-16 h-16 rounded-lg shadow-sm">
                 <div>
                    <h1 class="text-2xl font-bold text-gray-900">Boolean Editor</h1>
                    <p class="text-gray-500 mt-1" data-i18n="subtitle">For Homey Boolean Toolbox (Self-hosted)</p>
                 </div>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <button id="api-settings-button" class="hidden px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors text-sm border border-gray-300" data-i18n="apiSettings">
                    ‚öôÔ∏è API Settings
                </button>
                <div class="language-selector">
                    <button id="language-button" class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors border border-gray-300">
                        <span id="current-flag" class="text-xl">üá¨üáß</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="language-dropdown" class="language-dropdown">
                        <div class="language-option" data-lang="en">
                            <span class="text-xl">üá¨üáß</span>
                            <span>English</span>
                        </div>
                        <div class="language-option" data-lang="no">
                            <span class="text-xl">üá≥üá¥</span>
                            <span>Norsk</span>
                        </div>
                        <div class="language-option" data-lang="de">
                            <span class="text-xl">üá©üá™</span>
                            <span>Deutsch</span>
                        </div>
                        <div class="language-option" data-lang="fr">
                            <span class="text-xl">üá´üá∑</span>
                            <span>Fran√ßais</span>
                        </div>
                        <div class="language-option" data-lang="nl">
                            <span class="text-xl">üá≥üá±</span>
                            <span>Nederlands</span>
                        </div>
                    </div>
                </div>
                <div id="user-info" class="hidden text-right">
                    <p id="user-name" class="font-semibold text-gray-900"></p>
                    <p id="homey-name" class="text-sm text-gray-500"></p>
                    <button id="logout-button" class="text-sm text-red-600 hover:text-red-500" data-i18n="logout">Log out</button>
                </div>
            </div>
        </header>

        <main id="main-content" class="bg-white rounded-xl shadow-xl border border-gray-200 p-6 md:p-8">
            <!-- API Setup Screen -->
            <div id="api-setup-screen" class="screen active">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900" data-i18n="apiSetup.title">üîß API Setup Required</h2>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-blue-800" data-i18n="apiSetup.instructionsTitle">üìã How to get your API credentials:</h3>
                        <ol class="space-y-3 text-sm text-gray-700">
                            <li class="flex gap-3">
                                <span class="font-bold text-blue-600">1.</span>
                                <span><span data-i18n="apiSetup.step1">Go to</span> <a href="https://tools.developer.homey.app/api/clients" target="_blank" class="text-blue-600 hover:text-blue-500 underline" data-i18n="apiSetup.step1Link">Homey API Clients</a></span>
                            </li>
                            <li class="flex gap-3">
                                <span class="font-bold text-blue-600">2.</span>
                                <span data-i18n="apiSetup.step2">Click "Add client" or "Create new client"</span>
                            </li>
                            <li class="flex gap-3">
                                <span class="font-bold text-blue-600">3.</span>
                                <span data-i18n="apiSetup.step3">Fill in any name (e.g., "Boolean Editor")</span>
                            </li>
                            <li class="flex gap-3">
                                <span class="font-bold text-blue-600">4.</span>
                                <span data-i18n="apiSetup.step4">Add your Redirect URL (see below)</span>
                            </li>
                            <li class="flex gap-3">
                                <span class="font-bold text-blue-600">5.</span>
                                <span><strong>Select scopes:</strong> Check ‚úÖ <code class="bg-gray-100 px-1 rounded border border-gray-300">homey.zone.readonly</code>, <code class="bg-gray-100 px-1 rounded border border-gray-300">homey.device.readonly</code>, and <code class="bg-gray-100 px-1 rounded border border-gray-300">homey.device.control</code></span>
                            </li>
                            <li class="flex gap-3">
                                <span class="font-bold text-blue-600">6.</span>
                                <span data-i18n="apiSetup.step5">Click "Create" and copy the Client ID and Client Secret</span>
                            </li>
                        </ol>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-6 mb-6 border border-gray-200">
                        <h3 class="text-lg font-semibold mb-3 text-gray-900" data-i18n="apiSetup.redirectUrlTitle">üåê Your Redirect URL</h3>
                        <p class="text-sm text-gray-500 mb-2" data-i18n="apiSetup.redirectUrlHelp">Use this exact URL when creating your Cloud App:</p>
                        <div class="flex gap-2">
                            <input type="text" id="redirect-url-display" readonly class="flex-grow p-2 bg-white border border-gray-300 rounded font-mono text-sm text-gray-700" value="">
                            <button onclick="app.copyRedirectUrl()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors" data-i18n="apiSetup.copyButton">Copy</button>
                        </div>
                    </div>

                    <form id="api-setup-form" class="space-y-4">
                        <div>
                            <label for="client-id-input" class="block text-sm font-medium mb-2 text-gray-700" data-i18n="apiSetup.clientIdLabel">Client ID</label>
                            <input type="text" id="client-id-input" required class="w-full p-3 bg-white border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-gray-900">
                        </div>
                        <div>
                            <label for="client-secret-input" class="block text-sm font-medium mb-2 text-gray-700" data-i18n="apiSetup.clientSecretLabel">Client Secret</label>
                            <input type="password" id="client-secret-input" required class="w-full p-3 bg-white border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-gray-900">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors" data-i18n="apiSetup.saveButton">
                            Save and Continue
                        </button>
                    </form>
                </div>
            </div>

            <div id="login-screen" class="screen text-center p-16"></div>
            
            <!-- Main Menu -->
            <div id="main-menu-screen" class="screen">
                <h2 class="text-xl font-bold mb-6 text-center text-gray-900">What would you like to work with?</h2>
                <div class="grid md:grid-cols-4 gap-6 max-w-6xl mx-auto">
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors cursor-pointer" onclick="window.app.showScreen('edit-devices-screen')">
                        <h3 class="text-lg font-semibold mb-2 text-gray-900">‚öôÔ∏è Manage Existing Devices</h3>
                        <p class="text-gray-600 text-sm">View and modify settings for existing Boolean Toolbox devices.</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all cursor-pointer shadow-lg text-white" onclick="window.app.startLogicUnitFlow()">
                        <h3 class="text-lg font-semibold mb-2">üî¢ Logic Unit</h3>
                        <p class="text-blue-50 text-sm">Create or edit formulas with predefined inputs (A, B, C...).</p>
                        <p class="text-xs text-blue-100 mt-2">‚Ä¢ Multiple formulas supported</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-lg hover:from-green-600 hover:to-green-700 transition-all cursor-pointer shadow-lg text-white" onclick="window.app.startLogicDeviceFlow()">
                        <h3 class="text-lg font-semibold mb-2">üîó Logic Device</h3>
                        <p class="text-green-50 text-sm">Connect device capabilities and create boolean expressions.</p>
                        <p class="text-xs text-green-100 mt-2">‚Ä¢ Single formula with device inputs</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all cursor-pointer shadow-lg text-white" onclick="window.app.startSnapshotFlow()">
                        <h3 class="text-lg font-semibold mb-2">üì∏ Snapshot Manager</h3>
                        <p class="text-purple-50 text-sm">Capture device states and create Restore JSON.</p>
                        <p class="text-xs text-purple-100 mt-2">‚Ä¢ Filter and export state</p>
                    </div>
                </div>
            </div>

            <!-- Edit Devices Screen -->
            <div id="edit-devices-screen" class="screen">
                <button class="mb-6 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300" onclick="app.showScreen('main-menu-screen')">
                    <span data-i18n="back">‚Üê Back to menu</span>
                </button>
                <h2 class="text-xl font-bold mb-4 text-gray-900" data-i18n="editDevices.title">Edit Boolean Toolbox Devices</h2>
                <div id="edit-devices-list" class="space-y-6"></div>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
                <div class="bg-white rounded-lg p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl border border-gray-200">
                    <h3 id="settings-modal-title" class="text-lg font-bold mb-4 text-gray-900" data-i18n="settings.title">Settings</h3>
                    <div id="settings-modal-content" class="space-y-4"></div>
                    <div class="mt-6 flex justify-end gap-4 sticky bottom-0 bg-white pt-4 border-t border-gray-200">
                        <button id="settings-modal-close" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300" data-i18n="close">Close</button>
                        <button id="settings-modal-save" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm" data-i18n="save">Save</button>
                    </div>
                </div>
            </div>

            <!-- Logic Unit Select Screen -->
            <div id="logic-unit-select-screen" class="screen">
                <button class="mb-6 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300" onclick="app.showScreen('main-menu-screen')">
                    <span>‚Üê Back to menu</span>
                </button>
                <h2 class="text-xl font-bold mb-6 text-gray-900">Logic Unit</h2>
                <div class="grid md:grid-cols-2 gap-6 max-w-4xl">
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors cursor-pointer" onclick="app.showScreen('logic-unit-port-screen')">
                        <h3 class="text-lg font-semibold mb-2 text-gray-900">‚ûï Create New</h3>
                        <p class="text-gray-600">Create a new Logic Unit with custom formulas.</p>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors cursor-pointer" onclick="app.selectExistingLogicUnit()">
                        <h3 class="text-lg font-semibold mb-2 text-gray-900">‚úèÔ∏è Edit Existing</h3>
                        <p class="text-gray-600">Modify an existing Logic Unit device.</p>
                    </div>
                </div>
            </div>
            
            <!-- Logic Unit Port Select -->
            <div id="logic-unit-port-screen" class="screen">
                <button class="mb-6 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300" onclick="app.showScreen('logic-unit-select-screen')">
                    <span>‚Üê Back</span>
                </button>
                <h2 class="text-xl font-bold mb-6 text-gray-900">How many inputs?</h2>
                <p class="text-gray-600 mb-6">Select the number of inputs (A, B, C...) for your Logic Unit.</p>
                <div class="grid grid-cols-3 md:grid-cols-5 gap-4 max-w-4xl">
                    <button onclick="window.app.setLogicUnitPorts(2)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-4 rounded-lg text-2xl transition-colors shadow-sm">2</button>
                    <button onclick="window.app.setLogicUnitPorts(3)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-4 rounded-lg text-2xl transition-colors shadow-sm">3</button>
                    <button onclick="window.app.setLogicUnitPorts(4)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-4 rounded-lg text-2xl transition-colors shadow-sm">4</button>
                    <button onclick="window.app.setLogicUnitPorts(5)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-4 rounded-lg text-2xl transition-colors shadow-sm">5</button>
                    <button onclick="window.app.setLogicUnitPorts(6)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-4 rounded-lg text-2xl transition-colors shadow-sm">6</button>
                    <button onclick="window.app.setLogicUnitPorts(7)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-4 rounded-lg text-2xl transition-colors shadow-sm">7</button>
                    <button onclick="window.app.setLogicUnitPorts(8)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-4 rounded-lg text-2xl transition-colors shadow-sm">8</button>
                    <button onclick="window.app.setLogicUnitPorts(9)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-4 rounded-lg text-2xl transition-colors shadow-sm">9</button>
                    <button onclick="window.app.setLogicUnitPorts(10)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-4 rounded-lg text-2xl transition-colors shadow-sm">10</button>
                </div>
            </div>
            
            <!-- Logic Unit Editor -->
            <div id="logic-unit-editor-screen" class="screen">
                <button class="mb-6 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300" onclick="app.showScreen('logic-unit-select-screen')">
                    <span>‚Üê Back</span>
                </button>
                <h2 class="text-xl font-bold mb-4 text-gray-900">Logic Unit Formula Editor</h2>
                <div id="logic-unit-inputs-info" class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6 text-blue-900"></div>
                
                <div class="space-y-6" id="logic-unit-formulas-container"></div>
                
                <button onclick="app.addLogicUnitFormula()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors">
                    ‚ûï Add Formula
                </button>
                
                <button onclick="app.saveLogicUnit()" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors">
                    üíæ Save Logic Unit
                </button>
            </div>
            
            <!-- Logic Device Select -->
            <div id="logic-device-select-screen" class="screen">
                <button class="mb-6 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300" onclick="app.showScreen('main-menu-screen')">
                    <span>‚Üê Back to menu</span>
                </button>
                <h2 class="text-xl font-bold mb-6 text-gray-900">Logic Device</h2>
                <div class="grid md:grid-cols-2 gap-6 max-w-4xl">
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors cursor-pointer" onclick="app.showScreen('logic-device-editor-screen')">
                        <h3 class="text-lg font-semibold mb-2 text-gray-900">‚ûï Create New</h3>
                        <p class="text-gray-600">Create a new Logic Device with device capabilities.</p>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors cursor-pointer" onclick="app.selectExistingLogicDevice()">
                        <h3 class="text-lg font-semibold mb-2 text-gray-900">‚úèÔ∏è Edit Existing</h3>
                        <p class="text-gray-600">Modify an existing Logic Device.</p>
                    </div>
                </div>
            </div>
            
            <!-- Logic Device Editor -->
            <div id="logic-device-editor-screen" class="screen">
                <button class="mb-6 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300" onclick="app.showScreen('logic-device-select-screen')">
                    <span>‚Üê Back</span>
                </button>
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="flex-grow">
                        <h2 class="text-xl font-bold mb-4 text-gray-900">Select Devices and Capabilities</h2>
                        <p class="text-gray-600 mb-6">Select between 2 and 10 capabilities (A-J).</p>
                        <div id="logic-device-capability-list" class="space-y-4"></div>
                    </div>
                    <aside class="w-full lg:w-2/5 lg:sticky top-8 self-start space-y-6">
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <h3 class="text-lg font-semibold mb-4 text-gray-900">
                                Selected (<span id="logic-device-count">0</span>/10)
                            </h3>
                            <ul id="logic-device-selected-list" class="space-y-2 mb-4 max-h-64 overflow-y-auto"></ul>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <h3 class="text-lg font-semibold mb-2 text-gray-900">Formula</h3>
                            <p class="text-xs text-gray-500 mb-2">
                                Operators: <code class="bg-gray-100 px-1 rounded border border-gray-300">AND</code> <code class="bg-gray-100 px-1 rounded border border-gray-300">*</code> ¬∑ 
                                <code class="bg-gray-100 px-1 rounded border border-gray-300">OR</code> <code class="bg-gray-100 px-1 rounded border border-gray-300">+</code> ¬∑ 
                                <code class="bg-gray-100 px-1 rounded border border-gray-300">NOT</code> <code class="bg-gray-100 px-1 rounded border border-gray-300">!</code> ¬∑ 
                                <code class="bg-gray-100 px-1 rounded border border-gray-300">XOR</code> <code class="bg-gray-100 px-1 rounded border border-gray-300">^</code>
                                Parentheses <code class="bg-gray-100 px-1 rounded border border-gray-300">()</code>
                            </p>
                            <textarea id="logic-device-formula" class="w-full h-32 p-3 bg-white border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 font-mono text-sm text-gray-900" placeholder="Examples: (A AND B) OR C
A * B + !C
a or (b and c)"></textarea>
                            
                            <div id="logic-device-truth-table" class="mt-4"></div>
                        </div>
                        
                        <button onclick="app.saveLogicDevice()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors">
                            üíæ Save Logic Device
                        </button>
                    </aside>
                </div>
            </div>

            <!-- Snapshot Screen -->
            <div id="snapshot-screen" class="screen">
                <button class="mb-6 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300" onclick="app.showScreen('main-menu-screen')">
                    <span>‚Üê Back to menu</span>
                </button>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Snapshot Manager</h2>
                        <p class="text-gray-600 text-sm mt-1">Capture device states, remove unwanted items, and export JSON.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="app.captureState()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-sm transition-colors">
                            üì∏ Capture Current State
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
                        <h3 class="font-semibold text-lg text-gray-900">Captured Items (<span id="snapshot-count">0</span>)</h3>
                        <button id="snapshot-copy-btn" onclick="app.copySnapshotJSON()" class="hidden bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded transition-colors shadow-sm">
                            üìã Copy JSON
                        </button>
                    </div>
                    
                    <div id="snapshot-list" class="space-y-0 max-h-[60vh] overflow-y-auto">
                        <div class="text-gray-500 text-center py-10 italic">
                            Click "Capture Current State" to begin.
                        </div>
                    </div>
                </div>
            </div>
            
        </main>
        
        <!-- Loading Modal -->
        <div id="loader-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-lg p-8 flex flex-col items-center gap-4 shadow-xl border border-gray-200">
                <svg class="animate-spin h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-gray-900 text-lg" id="loader-text">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        const flags = {
            en: 'üá¨üáß',
            no: 'üá≥üá¥',
            de: 'üá©üá™',
            fr: 'üá´üá∑',
            nl: 'üá≥üá±'
        };

        const defaultTranslations = {
            en: {
                subtitle: "For Homey Boolean Toolbox (Self-hosted)",
                logout: "Log out",
                back: "‚Üê Back to menu",
                close: "Close",
                save: "Save",
                apiSettings: "‚öôÔ∏è API Settings",
                apiSetup: {
                    title: "üîß API Setup Required",
                    instructionsTitle: "üìã How to get your API credentials:",
                    step1: "Go to",
                    step1Link: "Homey API Clients",
                    step2: "Click \"Add client\" or \"Create new client\"",
                    step3: "Fill in any name (e.g., \"Boolean Editor\")",
                    step4: "Add your Redirect URL (see below)",
                    step5: "Click \"Create\" and copy the Client ID and Client Secret",
                    redirectUrlTitle: "üåê Your Redirect URL",
                    redirectUrlHelp: "Use this exact URL when creating your Cloud App:",
                    copyButton: "Copy",
                    clientIdLabel: "Client ID",
                    clientIdPlaceholder: "Enter your Client ID",
                    clientSecretLabel: "Client Secret",
                    clientSecretPlaceholder: "Enter your Client Secret",
                    saveButton: "Save and Continue",
                    changeConfirm: "Do you want to change your API credentials? This will log you out.",
                    copiedToClipboard: "Redirect URL copied to clipboard!"
                },
                login: {
                    welcome: "Welcome to Boolean Editor",
                    message: "Log in with your Athom account to get started.",
                    button: "Log in with Athom"
                },
                errors: {
                    startApp: "Failed to start application:",
                    authFailed: "Authentication failed:",
                    noHomey: "No Homey found on your account.",
                    afterLogin: "Error after login:",
                    fetchData: "Failed to fetch data:",
                },
                editDevices: {
                    title: "Edit Boolean Toolbox Devices",
                    noDevices: "No Boolean Toolbox devices found",
                    settings: "Settings",
                },
                settings: {
                    title: "Settings",
                    titleFor: "Settings for",
                    loading: "Loading settings...",
                    noSettings: "No settings available",
                    error: "Error:",
                    saved: "Settings saved successfully!"
                },
                step1: {
                    noneSelected: "No capabilities selected yet"
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            class BooleanToolboxApp {
                CLIENT_ID = null;
                CLIENT_SECRET = null;
                cloudApi = null;
                authenticatedUser = null;
                homey = null;
                api = null;
                allDevices = {};
                allZones = {};
                selectedCapabilities = [];
                processingAuth = false;
                currentLang = 'en';
                translations = {};
                snapshotData = [];

                constructor() {
                    this.currentLang = localStorage.getItem('language') || 'en';
                    this.editingDeviceId = null;
                    this.logicUnitFormulas = [];
                    this.logicUnitPorts = 0;
                    this.logicDeviceCapabilities = [];
                    this.evaluationDebounceTimer = null; 
                    this.init();
                }

                getRedirectUrl() {
                    return window.location.origin + window.location.pathname;
                }

                copyRedirectUrl() {
                    const input = document.getElementById('redirect-url-display');
                    input.select();
                    document.execCommand('copy');
                    alert(this.t('apiSetup.copiedToClipboard'));
                }

                async loadTranslations(lang) {
                    try {
                        const response = await fetch(`resources/lang.${lang}.json`);
                        if (!response.ok) throw new Error(`Failed to load language: ${lang}`);
                        this.translations = await response.json();
                        return true;
                    } catch (error) {
                        console.warn(`Failed to load ${lang} translations, using fallback:`, error);
                        this.translations = defaultTranslations[lang] || defaultTranslations.en;
                        return false;
                    }
                }

                async initLanguageSelector() {
                    await this.loadTranslations(this.currentLang);
                    
                    const languageButton = document.getElementById('language-button');
                    const languageDropdown = document.getElementById('language-dropdown');
                    const currentFlag = document.getElementById('current-flag');
                    
                    languageButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        languageDropdown.classList.toggle('active');
                    });

                    document.addEventListener('click', () => {
                        languageDropdown.classList.remove('active');
                    });

                    document.querySelectorAll('.language-option').forEach(option => {
                        option.addEventListener('click', async (e) => {
                            const lang = e.currentTarget.dataset.lang;
                            await this.setLanguage(lang);
                            languageDropdown.classList.remove('active');
                        });
                    });

                    currentFlag.textContent = flags[this.currentLang];
                    this.updateTranslations();
                }

                async setLanguage(lang) {
                    await this.loadTranslations(lang);
                    this.currentLang = lang;
                    localStorage.setItem('language', lang);
                    document.getElementById('current-flag').textContent = flags[lang];
                    this.updateTranslations();
                    
                    if (this.allDevices && Object.keys(this.allDevices).length > 0) {
                        this.renderAll();
                    }
                    this.renderSelectedCapabilities();
                    this.renderLoginScreen();
                }

                t(key) {
                    const keys = key.split('.');
                    let value = this.translations;
                    for (const k of keys) {
                        value = value?.[k];
                    }
                    return value || key;
                }

                updateTranslations() {
                    document.querySelectorAll('[data-i18n]').forEach(element => {
                        const key = element.getAttribute('data-i18n');
                        element.textContent = this.t(key);
                    });
                    
                    const clientIdInput = document.getElementById('client-id-input');
                    const clientSecretInput = document.getElementById('client-secret-input');
                    if (clientIdInput) clientIdInput.placeholder = this.t('apiSetup.clientIdPlaceholder');
                    if (clientSecretInput) clientSecretInput.placeholder = this.t('apiSetup.clientSecretPlaceholder');
                }

                async init() {
                    try {
                        if (typeof AthomCloudAPI === 'undefined') {
                            throw new Error("AthomCloudAPI script did not load correctly. Please check your internet connection and ad-blockers.");
                        }

                        await window.HomeyLibrariesReady;
                        document.getElementById('redirect-url-display').value = this.getRedirectUrl();
                        await this.initLanguageSelector();

                        this.CLIENT_ID = localStorage.getItem('homey_client_id');
                        this.CLIENT_SECRET = localStorage.getItem('homey_client_secret');

                        if (!this.CLIENT_ID || !this.CLIENT_SECRET) {
                            this.showScreen('api-setup-screen');
                            this.setupApiForm();
                            return;
                        }

                        this.cloudApi = new AthomCloudAPI({ clientId: this.CLIENT_ID, clientSecret: this.CLIENT_SECRET });
                        this.setupEventListeners();
                        this.renderLoginScreen();

                        const urlParams = new URLSearchParams(window.location.search);
                        const code = urlParams.get('code');

                        if (code) {
                            if (!this.CLIENT_ID || !this.CLIENT_SECRET) {
                                console.warn('Received auth code but no credentials stored');
                                window.location.href = window.location.pathname; 
                                return;
                            }
                            await this.handleAuthRedirect(code);
                        } else if (await this.cloudApi.isLoggedIn()) {
                            await this.postLogin();
                        } else {
                            this.showScreen('login-screen');
                        }

                        document.getElementById('api-settings-button').classList.remove('hidden');
                    } catch (error) {
                        console.error("Initialization failed:", error);
                        this.showError('Failed to start application: ' + error.message);
                    }
                }

                setupApiForm() {
                    const form = document.getElementById('api-setup-form');
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const clientId = document.getElementById('client-id-input').value.trim();
                        const clientSecret = document.getElementById('client-secret-input').value.trim();
                        
                        if (clientId && clientSecret) {
                            localStorage.setItem('homey_client_id', clientId);
                            localStorage.setItem('homey_client_secret', clientSecret);
                            this.CLIENT_ID = clientId;
                            this.CLIENT_SECRET = clientSecret;
                            window.location.reload();
                        }
                    });
                }
                
                setupEventListeners() {
                    document.getElementById('main-content').addEventListener('click', (event) => {
                        if (event.target.id === 'login-button') this.login();
                    });
                    document.getElementById('logout-button').addEventListener('click', () => this.logout());
                    document.getElementById('settings-modal-close').addEventListener('click', () => this.closeSettingsModal());
                    document.getElementById('settings-modal-save').addEventListener('click', () => this.saveSettings());
                    document.getElementById('api-settings-button').addEventListener('click', () => this.showApiSettings());
                }

                showApiSettings() {
                    const currentId = localStorage.getItem('homey_client_id') || '';
                    const currentSecret = localStorage.getItem('homey_client_secret') || '';
                    
                    if (confirm(this.t('apiSetup.changeConfirm'))) {
                        document.getElementById('client-id-input').value = currentId;
                        document.getElementById('client-secret-input').value = currentSecret;
                        this.showScreen('api-setup-screen');
                    }
                }

                async login() {
                    if (!this.CLIENT_ID) return this.showError("Client ID missing. Cannot start login.");
                    const redirectUrl = this.getRedirectUrl();
                    const authorizationUrl = `https://api.athom.com/oauth2/authorise?response_type=code&client_id=${this.CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUrl)}`;
                    window.location.href = authorizationUrl;
                }

                async handleAuthRedirect(code) {
                    if (this.processingAuth) return;
                    this.processingAuth = true;
                    window.history.replaceState({}, document.title, window.location.pathname); 
                    
                    this.showLoader('Authenticating...');
                    try {
                        await this.cloudApi.authenticateWithAuthorizationCode({
                            code: code,
                            redirectUrl: this.getRedirectUrl()
                        });
                        await this.postLogin();
                    } catch (error) {
                        console.error('Auth error:', error);
                        this.hideLoader();
                        this.showError(this.t('errors.authFailed') + ' ' + error.message);
                    } finally {
                        this.processingAuth = false;
                    }
                }
                
                async logout() {
                    try { await this.cloudApi.logout(); } catch(e) { console.error("Logout failed, continuing.", e); }
                    this.authenticatedUser = null; 
                    this.homey = null; 
                    this.api = null;
                    document.getElementById('user-info').classList.add('hidden');
                    this.renderLoginScreen();
                    this.showScreen('login-screen');
                }

                async postLogin() {
                    try {
                        this.showLoader('Loading user data...');
                        this.authenticatedUser = await this.cloudApi.getAuthenticatedUser();
                        const homeys = await this.authenticatedUser.getHomeys();
                        this.homey = homeys[0];
                        if (!this.homey) throw new Error(this.t('errors.noHomey'));
                        
                        this.api = await this.homey.authenticate();
                        if (!this.api.devices || !this.api.zones) throw new Error('API missing required properties (devices or zones)');

                        document.getElementById('user-name').textContent = this.authenticatedUser.nickname;
                        document.getElementById('homey-name').textContent = `Homey: ${this.homey.name}`;
                        document.getElementById('user-info').classList.remove('hidden');

                        await this.fetchData();
                        this.renderAll();
                        this.hideLoader();
                        this.showScreen('main-menu-screen');
                    } catch (error) {
                        console.error('postLogin error:', error);
                        this.hideLoader();
                        this.showError(this.t('errors.afterLogin') + ' ' + error.message);
                        await this.logout();
                    }
                }

                async fetchData() {
                    this.showLoader('Loading devices...');
                    try {
                        const devices = await this.api.devices.getDevices();
                        const zones = await this.api.zones.getZones();
                        this.allDevices = devices || {};
                        this.allZones = zones || {};
                    } catch (error) { 
                        this.hideLoader();
                        console.error('fetchData error:', error);
                        this.showError(this.t('errors.fetchData') + ' ' + error.message); 
                    }
                }

                renderAll() { 
                    this.renderEditDevices(); 
                }
                
                renderEditDevices() {
                    const container = document.getElementById('edit-devices-list');
                    container.innerHTML = '';
                    const allDevicesList = Object.values(this.allDevices);
                    const possibleDriverIds = ['booleantoolbox', 'logic', 'boolean', 'toolbox'];
                    let toolboxDevices = allDevicesList.filter(d => 
                        possibleDriverIds.some(id => d.driverId.toLowerCase().includes(id))
                    );
                    
                    if (toolboxDevices.length === 0) {
                        container.innerHTML = `<div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-center"><p class="font-semibold mb-2 text-yellow-800">${this.t('editDevices.noDevices')}</p></div>`;
                        return;
                    }
                    
                    const devicesByZone = this.groupDevicesByZone(toolboxDevices);
                    const sortedZones = this.sortZones(Object.keys(devicesByZone));
                    
                    sortedZones.forEach(zoneId => {
                        if (!devicesByZone[zoneId]) return;
                        const zone = this.allZones[zoneId];
                        const zoneDevices = devicesByZone[zoneId];
                        const zoneEl = document.createElement('div');
                        zoneEl.className = 'mt-6';
                        zoneEl.innerHTML = `<h3 class="text-lg font-semibold border-b border-gray-200 pb-2 mb-4 text-gray-800">${zone.name}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${zoneDevices.map(device => {
                                const isLogicUnit = device.driverId.includes('logic-unit');
                                const buttonText = isLogicUnit ? 'Edit Formula' : 'Edit Expression';
                                const buttonClass = isLogicUnit ? 'edit-formula-button' : 'edit-expression-button';
                                return `
                                <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-medium text-gray-900">${device.name}</span>
                                        <div class="flex gap-2">
                                            <button data-device-id="${device.id}" class="${buttonClass} bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-2 rounded-md transition-colors">${buttonText}</button>
                                            <button data-device-id="${device.id}" class="open-settings-button bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 text-xs py-1 px-2 rounded-md transition-colors">${this.t('editDevices.settings')}</button>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 font-mono">${device.driverId}</div>
                                </div>`;
                            }).join('')}</div>`;
                        container.appendChild(zoneEl);
                    });
                    
                    container.querySelectorAll('.open-settings-button').forEach(button => button.addEventListener('click', (e) => this.openSettingsModal(e.target.dataset.deviceId)));
                    container.querySelectorAll('.edit-expression-button').forEach(button => button.addEventListener('click', (e) => this.editDeviceExpression(e.target.dataset.deviceId)));
                    container.querySelectorAll('.edit-formula-button').forEach(button => button.addEventListener('click', (e) => this.editDeviceFormula(e.target.dataset.deviceId)));
                }

                renderLogicDeviceCapabilityList() {
                    const container = document.getElementById('logic-device-capability-list');
                    if (!container) return;
                    container.innerHTML = '';
                    const allDevicesList = Object.values(this.allDevices);
                    const devicesByZone = this.groupDevicesByZone(allDevicesList);
                    const sortedZones = this.sortZones(Object.keys(devicesByZone));
                    
                    sortedZones.forEach(zoneId => {
                        if (!devicesByZone[zoneId] || !this.allZones[zoneId]) return;
                        const zone = this.allZones[zoneId];
                        const zoneDevices = devicesByZone[zoneId];
                        
                        const zoneWrapper = document.createElement('div');
                        zoneWrapper.className = 'mb-4 border border-gray-300 rounded-lg overflow-hidden';
                        
                        const zoneHeader = document.createElement('div');
                        zoneHeader.className = 'bg-gray-100 p-3 cursor-pointer hover:bg-gray-200 flex justify-between items-center text-gray-900';
                        zoneHeader.innerHTML = `
                            <h3 class="font-semibold">${zone.name}</h3>
                            <svg class="zone-chevron w-4 h-4 transition-transform text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        `;
                        
                        const zoneContent = document.createElement('div');
                        zoneContent.className = 'hidden bg-white p-3 space-y-2';
                        
                        zoneDevices.forEach(device => {
                            if (!device.capabilitiesObj || Object.keys(device.capabilitiesObj).length === 0) return;
                            
                            const deviceWrapper = document.createElement('div');
                            deviceWrapper.className = 'border border-gray-200 rounded overflow-hidden';
                            
                            const deviceHeader = document.createElement('div');
                            deviceHeader.className = 'bg-gray-50 p-2 cursor-pointer hover:bg-gray-100 flex justify-between items-center';
                            deviceHeader.innerHTML = `
                                <div class="font-medium text-sm text-gray-800">${device.name}</div>
                                <svg class="device-chevron w-3 h-3 transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            `;
                            
                            const capsEl = document.createElement('div');
                            capsEl.className = 'hidden bg-white space-y-1 p-2 border-t border-gray-100';
                            
                            Object.values(device.capabilitiesObj).forEach(cap => {
                                const isSelected = this.logicDeviceCapabilities.some(
                                    c => c.deviceId === device.id && c.capabilityId === cap.id
                                );
                                
                                const label = document.createElement('label');
                                label.className = 'flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-1 rounded text-gray-700';
                                label.innerHTML = `
                                    <input type="checkbox" ${isSelected ? 'checked' : ''} data-device-id="${device.id}" data-capability-id="${cap.id}" data-device-name="${device.name}" data-capability-title="${cap.title}" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span>${cap.title}</span>
                                `;
                                
                                const checkbox = label.querySelector('input');
                                checkbox.addEventListener('change', (e) => this.handleLogicDeviceCapabilityChange(e.target));
                                capsEl.appendChild(label);
                            });
                            
                            deviceHeader.addEventListener('click', () => {
                                const isHidden = capsEl.classList.contains('hidden');
                                capsEl.classList.toggle('hidden');
                                deviceHeader.querySelector('.device-chevron').style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
                            });
                            
                            deviceWrapper.appendChild(deviceHeader);
                            deviceWrapper.appendChild(capsEl);
                            zoneContent.appendChild(deviceWrapper);
                        });
                        
                        zoneHeader.addEventListener('click', () => {
                            const isHidden = zoneContent.classList.contains('hidden');
                            zoneContent.classList.toggle('hidden');
                            zoneHeader.querySelector('.zone-chevron').style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
                        });
                        
                        zoneWrapper.appendChild(zoneHeader);
                        zoneWrapper.appendChild(zoneContent);
                        container.appendChild(zoneWrapper);
                    });
                    
                    this.updateLogicDeviceSelectedList();
                }

                handleLogicDeviceCapabilityChange(checkbox) {
                    const {deviceId, capabilityId, deviceName, capabilityTitle} = checkbox.dataset;
                    
                    if (checkbox.checked) {
                        if (this.logicDeviceCapabilities.length < 10) {
                            this.logicDeviceCapabilities.push({deviceId, capabilityId, deviceName, capabilityTitle});
                        } else {
                            checkbox.checked = false;
                            alert('Maximum 10 capabilities allowed');
                            return;
                        }
                    } else {
                        this.logicDeviceCapabilities = this.logicDeviceCapabilities.filter(
                            c => !(c.deviceId === deviceId && c.capabilityId === capabilityId)
                        );
                    }
                    
                    this.updateLogicDeviceSelectedList();
                    const formulaInput = document.getElementById('logic-device-formula');
                    if (formulaInput && formulaInput.value.trim()) {
                        this.updateLogicDeviceTruthTable(formulaInput.value.trim());
                    }
                }

                updateLogicDeviceSelectedList() {
                    const list = document.getElementById('logic-device-selected-list');
                    const count = document.getElementById('logic-device-count');
                    if (!list || !count) return;
                    count.textContent = this.logicDeviceCapabilities.length;
                    
                    list.innerHTML = this.logicDeviceCapabilities.length === 0 
                        ? '<li class="text-gray-500 text-sm italic">No capabilities selected</li>'
                        : this.logicDeviceCapabilities.map((cap, idx) => `
                            <li class="bg-gray-100 p-2 rounded text-sm border border-gray-200">
                                <div class="flex items-center gap-2">
                                    <div class="flex flex-col gap-1">
                                        <button onclick="window.app.moveLogicDeviceCapability(${idx}, -1)" ${idx === 0 ? 'disabled' : ''} class="text-gray-500 hover:text-gray-700 disabled:opacity-30 disabled:cursor-not-allowed text-xs leading-none" title="Move up">‚ñ≤</button>
                                        <button onclick="window.app.moveLogicDeviceCapability(${idx}, 1)" ${idx === this.logicDeviceCapabilities.length - 1 ? 'disabled' : ''} class="text-gray-500 hover:text-gray-700 disabled:opacity-30 disabled:cursor-not-allowed text-xs leading-none" title="Move down">‚ñº</button>
                                    </div>
                                    <div class="flex-grow min-w-0">
                                        <span class="font-mono font-bold text-blue-600">${String.fromCharCode(65 + idx)}:</span>
                                        <span class="text-xs block truncate text-gray-800">${cap.deviceName} - ${cap.capabilityTitle}</span>
                                    </div>
                                    <button onclick="window.app.removeLogicDeviceCapability(${idx})" class="text-red-500 hover:text-red-700 font-bold text-lg flex-shrink-0">√ó</button>
                                </div>
                            </li>
                        `).join('');
                    
                    const formulaInput = document.getElementById('logic-device-formula');
                    const currentFormula = formulaInput ? formulaInput.value : '';
                    if (formulaInput) {
                        const newInput = formulaInput.cloneNode(true);
                        formulaInput.parentNode.replaceChild(newInput, formulaInput);
                        newInput.addEventListener('input', () => {
                            const formula = newInput.value.trim();
                            if (this.evaluationDebounceTimer) clearTimeout(this.evaluationDebounceTimer);
                            this.evaluationDebounceTimer = setTimeout(() => {
                                this.updateLogicDeviceTruthTable(formula);
                            }, 500);
                        });
                    }
                    if (currentFormula.trim()) {
                        this.updateLogicDeviceTruthTable(currentFormula.trim());
                    }
                }

                moveLogicDeviceCapability(idx, direction) {
                    const newIdx = idx + direction;
                    if (newIdx < 0 || newIdx >= this.logicDeviceCapabilities.length) return;
                    [this.logicDeviceCapabilities[idx], this.logicDeviceCapabilities[newIdx]] = 
                    [this.logicDeviceCapabilities[newIdx], this.logicDeviceCapabilities[idx]];
                    this.updateLogicDeviceSelectedList();
                    const formulaInput = document.getElementById('logic-device-formula');
                    if (formulaInput && formulaInput.value.trim()) {
                        this.updateLogicDeviceTruthTable(formulaInput.value.trim());
                    }
                }

                removeLogicDeviceCapability(idx) {
                    const removed = this.logicDeviceCapabilities[idx];
                    this.logicDeviceCapabilities.splice(idx, 1);
                    const checkbox = document.querySelector(
                        `input[data-device-id="${removed.deviceId}"][data-capability-id="${removed.capabilityId}"]`
                    );
                    if (checkbox) checkbox.checked = false;
                    this.updateLogicDeviceSelectedList();
                    const formulaInput = document.getElementById('logic-device-formula');
                    if (formulaInput && formulaInput.value.trim()) {
                        this.updateLogicDeviceTruthTable(formulaInput.value.trim());
                    }
                }

                updateLogicDeviceTruthTable(formula) {
                    const truthTableContainer = document.getElementById('logic-device-truth-table');
                    if (!truthTableContainer) return;
                    if (!formula || this.logicDeviceCapabilities.length === 0) {
                        truthTableContainer.innerHTML = '';
                        return;
                    }
                    this.renderTruthTable(formula, this.logicDeviceCapabilities.length, 'logic-device-truth-table');
                }

                saveLogicUnit() {
                    if (this.logicUnitFormulas.length === 0 || !this.logicUnitFormulas[0].expression) {
                        alert('Please add at least one formula');
                        return;
                    }
                    const output = {
                        formulas: this.logicUnitFormulas.map(f => ({
                            id: f.id, name: f.name, expression: f.expression, enabled: f.enabled !== false, timeout: 30, firstImpression: false
                        }))
                    };
                    this.showOutputModal('Logic Unit Output', output, 'Copy this JSON and paste it in the "Formulas (JSON)" field in your Logic Unit device settings.');
                }

                saveLogicDevice() {
                    if (this.logicDeviceCapabilities.length < 2 || this.logicDeviceCapabilities.length > 10) {
                        alert('Please select between 2 and 10 capabilities');
                        return;
                    }
                    const formula = document.getElementById('logic-device-formula').value.trim();
                    if (!formula) { alert('Please enter a formula'); return; }
                    
                    const availableVars = Array.from({length: this.logicDeviceCapabilities.length}, (_, i) => String.fromCharCode(65 + i));
                    const usedVars = new Set((formula.toUpperCase().match(/\b[A-J]\b/g) || []));
                    const missingVars = Array.from(usedVars).filter(v => {
                        const idx = v.charCodeAt(0) - 65;
                        return idx >= this.logicDeviceCapabilities.length;
                    });
                    
                    if (missingVars.length > 0) {
                        alert(`Formula uses ${missingVars.join(', ')} but only ${availableVars.join(', ')} are selected. Please select more capabilities or update your formula.`);
                        return;
                    }
                    
                    const output = {
                        input_links: this.logicDeviceCapabilities.map((cap, idx) => ({
                            input: String.fromCharCode(97 + idx).toLowerCase(),
                            deviceId: cap.deviceId,
                            capability: cap.capabilityId,
                            deviceName: cap.deviceName
                        })),
                        formulas: [{
                            id: 'formula_1', name: 'Main Formula', expression: formula, enabled: true, timeout: 30, firstImpression: false
                        }]
                    };
                    this.showOutputModal('Logic Device Output', output, 'Copy these JSON objects and paste them in the respective fields in your Logic Device settings.');
                }

                showOutputModal(title, output, instructions) {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50';
                    modal.innerHTML = `
                        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                            <h3 class="text-lg font-bold mb-4">${title}</h3>
                            <p class="text-sm text-gray-400 mb-4">${instructions}</p>
                            ${output.input_links ? `
                                <div class="mb-4"><h4 class="font-semibold mb-2">Input Links (JSON):</h4><textarea readonly class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg font-mono text-sm" rows="8">${JSON.stringify(output.input_links, null, 2)}</textarea></div>
                            ` : ''}
                            <div class="mb-6"><h4 class="font-semibold mb-2">Formulas (JSON):</h4><textarea readonly class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg font-mono text-sm" rows="12">${JSON.stringify(output.formulas, null, 2)}</textarea></div>
                            <div class="flex justify-end gap-4">
                                <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Close</button>
                                <button onclick="navigator.clipboard.writeText('${JSON.stringify(output, null, 2).replace(/'/g, "\'")}'); alert('Copied to clipboard!')" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">Copy All JSON</button>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                }

                async editDeviceFormula(deviceId) {
                    const device = this.allDevices[deviceId];
                    if (!device || !device.settings) { alert('Could not load device settings'); return; }
                    this.editingDeviceId = deviceId;
                    try {
                        let formulas = device.settings.formulas || [];
                        if (typeof formulas === 'string') {
                            try { formulas = JSON.parse(formulas); } catch (e) { formulas = []; } 
                        }
                        this.logicUnitFormulas = formulas.length > 0 ? formulas : [{id: 'formula_1', name: 'My Formula', expression: '', enabled: true}];
                        const match = device.name.match(/\((\d+)\s+input/i);
                        if (match) {
                            this.logicUnitPorts = parseInt(match[1]);
                        } else {
                            const allVars = new Set();
                            this.logicUnitFormulas.forEach(f => {
                                const matches = f.expression.match(/\b[A-J]\b/g);
                                if (matches) matches.forEach(v => allVars.add(v));
                            });
                            this.logicUnitPorts = Math.max(3, allVars.size);
                        }
                        this.showScreen('logic-unit-editor-screen');
                        this.renderLogicUnitEditor();
                    } catch (error) {
                        alert('Failed to load formula: ' + error.message);
                    }
                }

                async editDeviceExpression(deviceId) {
                    const device = this.allDevices[deviceId];
                    if (!device) { alert('Could not load device'); return; }
                    this.showLoader('Loading expression...');
                    try {
                        let settings = device.settings || {};
                        try {
                            const freshSettings = await this.api.devices.getDevice({ id: deviceId });
                            if (freshSettings && freshSettings.settings) settings = freshSettings.settings;
                        } catch (e) {}
                        let inputLinks = settings.input_links || [];
                        if (typeof inputLinks === 'string') {
                            try { inputLinks = JSON.parse(inputLinks); } catch (e) {
                                this.hideLoader(); alert('Failed to parse input links JSON'); return;
                            }
                        }
                        if (!Array.isArray(inputLinks) || inputLinks.length === 0) {
                            this.hideLoader(); alert('No input links found.'); return;
                        }
                        this.logicDeviceCapabilities = [];
                        for (const link of inputLinks) {
                            const linkedDevice = this.allDevices[link.deviceId];
                            if (!linkedDevice) continue;
                            const capability = linkedDevice.capabilitiesObj?.[link.capability];
                            if (!capability) continue;
                            this.logicDeviceCapabilities.push({
                                deviceId: link.deviceId, capabilityId: link.capability,
                                deviceName: link.deviceName || linkedDevice.name, capabilityTitle: capability.title
                            });
                        }
                        let formulas = settings.formulas || [];
                        if (typeof formulas === 'string') { try { formulas = JSON.parse(formulas); } catch (e) { formulas = []; } }
                        let formulaText = '';
                        if (Array.isArray(formulas) && formulas.length > 0) {
                            const enabledFormula = formulas.find(f => f.enabled !== false);
                            if (enabledFormula) formulaText = enabledFormula.expression || '';
                        }
                        this.editingDeviceId = deviceId;
                        this.hideLoader();
                        this.showScreen('logic-device-editor-screen');
                        this.renderLogicDeviceCapabilityList();
                        const formulaInput = document.getElementById('logic-device-formula');
                        if (formulaInput) {
                            formulaInput.value = formulaText;
                            if (formulaText && this.logicDeviceCapabilities.length > 0) this.updateLogicDeviceTruthTable(formulaText);
                        }
                    } catch (error) {
                        this.hideLoader(); alert('Failed to load expression: ' + error.message);
                    }
                }

                renderSettingField(setting) {
                    const { id, title, value, type, hint, min, max, units } = setting;
                    const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : value;
                    const isObject = typeof value === 'object';
                    let fieldHtml = `<div class="mb-4"><label for="setting-${id}" class="block text-sm font-medium text-gray-700 mb-1">${title || id}</label>`;
                    if (hint) fieldHtml += `<p class="text-xs text-gray-500 mb-2">${hint}</p>`;
                    if (type === 'textarea' || isObject) {
                        const rows = isObject ? Math.min(10, displayValue.split('\n').length + 1) : 4;
                        fieldHtml += `<textarea id="setting-${id}" data-setting-id="${id}" data-is-object="${isObject}" class="block w-full p-2 bg-white border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 font-mono text-sm text-gray-900" rows="${rows}">${displayValue}</textarea>`;
                    } else if (type === 'number') {
                        fieldHtml += `<div class="flex gap-2 items-center"><input type="number" id="setting-${id}" data-setting-id="${id}" ${min !== undefined ? `min="${min}"` : ''} ${max !== undefined ? `max="${max}"` : ''} class="flex-grow p-2 bg-white border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-gray-900" value="${value}">${units ? `<span class="text-gray-500 text-sm">${units.en || units}</span>` : ''}</div>`;
                    } else {
                        fieldHtml += `<input type="text" id="setting-${id}" data-setting-id="${id}" class="block w-full p-2 bg-white border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-gray-900" value="${displayValue}">`;
                    }
                    fieldHtml += `</div>`;
                    return fieldHtml;
                }

                closeSettingsModal() { document.getElementById('settings-modal').style.display = 'none'; }

                async saveSettings() {
                    const deviceId = document.getElementById('settings-modal-save').dataset.deviceId;
                    const content = document.getElementById('settings-modal-content');
                    const fields = content.querySelectorAll('[data-setting-id]');
                    const newSettings = {};
                    try {
                        fields.forEach(field => {
                            const id = field.dataset.settingId;
                            const isObject = field.dataset.isObject === 'true';
                            const value = field.value.trim();
                            if (isObject) {
                                try { newSettings[id] = JSON.parse(value); } catch (e) { throw new Error(`Invalid JSON for field "${id}": ${e.message}`); }
                            } else if (field.type === 'number') {
                                newSettings[id] = parseFloat(value);
                            } else {
                                newSettings[id] = value;
                            }
                        });
                        this.showLoader('Saving settings...');
                        await this.api.devices.setDeviceSettings({ id: deviceId, settings: newSettings });
                        this.hideLoader();
                        alert(this.t('settings.saved'));
                        this.closeSettingsModal();
                    } catch (error) { 
                        this.hideLoader(); alert(this.t('settings.error') + ' ' + error.message); 
                    }
                }

                async openSettingsModal(deviceId) {
                    const device = this.allDevices[deviceId];
                    if (!device) return;
                    const modal = document.getElementById('settings-modal');
                    const title = document.getElementById('settings-modal-title');
                    const content = document.getElementById('settings-modal-content');
                    const saveBtn = document.getElementById('settings-modal-save');
                    title.textContent = `${this.t('settings.titleFor')} ${device.name}`;
                    content.innerHTML = `<p>${this.t('settings.loading')}</p>`;
                    saveBtn.dataset.deviceId = deviceId;
                    modal.style.display = 'flex';
                    this.showLoader('Loading settings...');
                    try {
                        const settingsSchema = await this.api.devices.getDeviceSettingsObj({ id: deviceId });
                        const mergeValues = (schema, values) => {
                            if (Array.isArray(schema)) {
                                return schema.map(item => {
                                    if (item.type === 'group' && item.children) {
                                        return { ...item, children: item.children.map(child => ({ ...child, value: values?.[child.id] !== undefined ? values[child.id] : child.value })) };
                                    } else if (item.id) {
                                        return { ...item, value: values?.[item.id] !== undefined ? values[item.id] : item.value };
                                    }
                                    return item;
                                });
                            }
                            return schema;
                        };
                        const settingsWithValues = mergeValues(settingsSchema, device.settings);
                        let settingsHtml = '';
                        if (Array.isArray(settingsWithValues)) {
                            settingsWithValues.forEach(group => {
                                if (group.type === 'group' && group.children) {
                                    settingsHtml += `<div class="mb-4"><h4 class="text-md font-semibold text-gray-200 mb-3">${group.title || 'Settings'}</h4>`;
                                    group.children.forEach(setting => { settingsHtml += this.renderSettingField(setting); });
                                    settingsHtml += `</div>`;
                                } else {
                                    settingsHtml += this.renderSettingField(group);
                                }
                            });
                        } else {
                            for (const key in settingsWithValues) {
                                const value = settingsWithValues[key];
                                settingsHtml += this.renderSettingField({ id: key, title: key, value: value });
                            }
                        }
                        content.innerHTML = settingsHtml || `<p>${this.t('settings.noSettings')}</p>`;
                    } catch(error) { 
                        content.innerHTML = `<p class="text-red-400">${this.t('settings.error')} ${error.message}</p>`; 
                    } finally { 
                        this.hideLoader(); 
                    }
                }

                renderSelectedCapabilities() {
                    const list = document.getElementById('selected-capabilities-list');
                    if (!list) return;
                    list.innerHTML = '';
                    if (this.selectedCapabilities.length === 0) list.innerHTML = `<li class="text-gray-500 text-center italic">${this.t('step1.noneSelected')}</li>`;
                    this.selectedCapabilities.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-700 p-2 rounded-md flex justify-between items-center text-sm';
                        li.innerHTML = `<span class="truncate"><span class="font-bold">${String.fromCharCode(65 + index)}:</span> ${item.deviceName} - ${item.capabilityTitle}</span><button data-index="${index}" class="remove-capability-btn text-red-400 hover:text-red-300 p-1 font-bold text-lg">&times;</button>`;
                        list.appendChild(li);
                    });
                    list.querySelectorAll('.remove-capability-btn').forEach(btn => btn.addEventListener('click', e => this.removeCapability(parseInt(e.currentTarget.dataset.index))));
                }

                renderLoginScreen() {
                     document.getElementById('login-screen').innerHTML = `<h2 class="text-xl font-bold mb-4">${this.t('login.welcome')}</h2><p class="mb-6 text-gray-300">${this.t('login.message')}</p><button id="login-button" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">${this.t('login.button')}</button>`;
                }

                showScreen(screenId) {
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    const screen = document.getElementById(screenId);
                    if (screen) screen.classList.add('active');
                }
                
                showLoader(text = 'Loading...') {
                    const loader = document.getElementById('loader-modal');
                    const loaderText = document.getElementById('loader-text');
                    loaderText.textContent = text;
                    loader.style.display = 'flex';
                }
                
                hideLoader() {
                    const loader = document.getElementById('loader-modal');
                    loader.style.display = 'none';
                }
                
                showError(message) {
                    const loginScreen = document.getElementById('login-screen');
                    loginScreen.innerHTML = `<p class="text-red-400 p-4 bg-red-900/50 rounded-lg">${message}</p>`;
                    this.showScreen('login-screen');
                }

                groupDevicesByZone(deviceList) {
                    return deviceList.reduce((acc, device) => {
                        const zone = device.zone;
                        if (!acc[zone]) acc[zone] = [];
                        acc[zone].push(device);
                        return acc;
                    }, {});
                }

                sortZones(zoneIds) {
                    const homeZoneId = Object.keys(this.allZones).find(id => {
                         if (!this.allZones[id]) return false;
                         return ['home', 'hjem', 'zuhause', 'maison', 'casa'].includes(this.allZones[id].name.toLowerCase())
                    });
                    return zoneIds.sort((a, b) => {
                        if (a === homeZoneId) return -1;
                        if (b === homeZoneId) return 1;
                        if (!this.allZones[a] || !this.allZones[b]) return 0;
                        return this.allZones[a].name.localeCompare(this.allZones[b].name);
                    });
                }

                startLogicUnitFlow() {
                    this.editingDeviceId = null;
                    this.logicUnitFormulas = [];
                    this.logicUnitPorts = 0;
                    this.showScreen('logic-unit-select-screen');
                }

                setLogicUnitPorts(num) {
                    this.logicUnitPorts = num;
                    this.logicUnitFormulas = [{
                        id: 'formula_1', name: 'My Formula', expression: '', enabled: true
                    }];
                    this.showScreen('logic-unit-editor-screen');
                    this.renderLogicUnitEditor();
                }

                renderLogicUnitEditor() {
                    const infoBox = document.getElementById('logic-unit-inputs-info');
                    const container = document.getElementById('logic-unit-formulas-container');
                    if (!infoBox || !container) return;
                    const inputs = Array.from({length: this.logicUnitPorts}, (_, i) => String.fromCharCode(65 + i));
                    infoBox.innerHTML = `<h3 class="font-semibold mb-2">Available Inputs:</h3><p class="text-blue-800">${inputs.join(', ')}</p>`;
                    container.innerHTML = this.logicUnitFormulas.map((formula, idx) => `
                        <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-semibold text-gray-900">Formula ${idx + 1}</h3>
                                ${this.logicUnitFormulas.length > 1 ? `<button onclick="window.app.removeLogicUnitFormula(${idx})" class="text-red-600 hover:text-red-500 text-sm">Remove</button>` : ''}
                            </div>
                            <div class="mb-3"><label class="block text-sm mb-1 text-gray-700">Name</label><input type="text" value="${formula.name}" onchange="window.app.updateLogicUnitFormulaName(${idx}, this.value)" class="w-full p-2 bg-white border border-gray-300 rounded text-gray-900 focus:border-blue-500 focus:outline-none"></div>
                            <div class="mb-3"><label class="block text-sm mb-1 text-gray-700">Expression</label><p class="text-xs text-gray-500 mb-1">Operators: AND, OR, NOT, XOR</p><textarea oninput="window.app.updateLogicUnitFormulaExpression(${idx}, this.value)" class="w-full h-24 p-2 bg-white border border-gray-300 rounded font-mono text-gray-900 focus:border-blue-500 focus:outline-none">${formula.expression}</textarea></div>
                            <div id="truth-table-${idx}" class="mt-3"></div>
                        </div>
                    `).join('');
                    this.logicUnitFormulas.forEach((formula, idx) => { if (formula.expression) this.renderTruthTable(formula.expression, this.logicUnitPorts, `truth-table-${idx}`); });
                }

                updateLogicUnitFormulaName(idx, name) { this.logicUnitFormulas[idx].name = name; }
                updateLogicUnitFormulaExpression(idx, expr) {
                    this.logicUnitFormulas[idx].expression = expr;
                    if (this.evaluationDebounceTimer) clearTimeout(this.evaluationDebounceTimer);
                    if (expr) { this.evaluationDebounceTimer = setTimeout(() => { this.renderTruthTable(expr, this.logicUnitPorts, `truth-table-${idx}`); }, 500); }
                    else { const c = document.getElementById(`truth-table-${idx}`); if(c) c.innerHTML = ''; }
                }

                addLogicUnitFormula() { this.logicUnitFormulas.push({ id: `formula_${this.logicUnitFormulas.length + 1}`, name: `Formula ${this.logicUnitFormulas.length + 1}`, expression: '', enabled: true }); this.renderLogicUnitEditor(); }
                removeLogicUnitFormula(idx) { this.logicUnitFormulas.splice(idx, 1); this.renderLogicUnitEditor(); }

                selectExistingLogicUnit() { this.showDeviceSelectionModal('logic-unit'); }
                selectExistingLogicDevice() { this.showDeviceSelectionModal('logic-device'); }

                showDeviceSelectionModal(type) {
                    const allDevicesList = Object.values(this.allDevices);
                    const devices = allDevicesList.filter(d => d.driverId.includes(type));
                    if (devices.length === 0) { alert(`No ${type} devices found`); return; }
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50';
                    modal.innerHTML = `
                        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                            <h3 class="text-lg font-bold mb-4">Select Device to Edit</h3>
                            <div class="space-y-2">${devices.map(d => `<button onclick="window.app.${type === 'logic-unit' ? 'editLogicUnit' : 'editLogicDevice'}('${d.id}'); this.closest('.fixed').remove()" class="w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><div class="font-semibold">${d.name}</div><div class="text-xs text-gray-400">${this.allZones[d.zone]?.name || 'Unknown zone'}</div></button>`).join('')}</div>
                            <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                        </div>`;
                    document.body.appendChild(modal);
                }

                editLogicUnit(deviceId) { this.editDeviceFormula(deviceId); }
                editLogicDevice(deviceId) { this.editDeviceExpression(deviceId); }

                startLogicDeviceFlow() {
                    this.editingDeviceId = null;
                    this.logicDeviceCapabilities = [];
                    this.showScreen('logic-device-select-screen');
                }

                evaluateExpression(expression, values) {
                    try {
                        let jsExpr = expression.toUpperCase().replace(/\bAND\b/gi, '&&').replace(/\bOR\b/gi, '||').replace(/\bNOT\b/gi, '!').replace(/\bXOR\b/gi, '^');
                        Object.keys(values).forEach(variable => {
                            const upperVar = variable.toUpperCase();
                            const regex = new RegExp(`\b${upperVar}\b`, 'g');
                            jsExpr = jsExpr.replace(regex, values[variable] ? 'true' : 'false');
                        });
                        return eval(jsExpr) ? 1 : 0;
                    } catch (e) { return null; }
                }

                renderTruthTable(expression, numInputs, containerId) {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    const inputs = Array.from({length: numInputs}, (_, i) => String.fromCharCode(65 + i));
                    const rows = Math.pow(2, numInputs);
                    if (rows > 256) { container.innerHTML = '<p class="text-yellow-600 text-sm">Too many inputs for truth table preview (max 8)</p>'; return; }
                    
                    const usedInputs = new Set((expression.toUpperCase().match(/\b[A-J]\b/g) || []));
                    const missingInputs = Array.from(usedInputs).filter(input => {
                        const idx = input.charCodeAt(0) - 65;
                        return idx >= numInputs;
                    });
                    
                    if (missingInputs.length > 0) {
                        container.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-3 text-sm text-red-800"><p class="font-semibold">‚ùå Error:</p><p>Formula uses <strong>${missingInputs.join(', ')}</strong> but only <strong>${inputs.join(', ')}</strong> ${numInputs === 1 ? 'is' : 'are'} selected.</p></div>`;
                        return;
                    }
                    
                    let html = `<div class="overflow-x-auto"><table class="w-full text-xs border-collapse"><thead><tr class="bg-gray-200 text-gray-700">${inputs.map(i => `<th class="border border-gray-300 p-1">${i}</th>`).join('')}<th class="border border-gray-300 p-1 font-bold">Result</th></tr></thead><tbody>`;
                    for (let i = 0; i < rows; i++) {
                        const values = {};
                        let rowHtml = '<tr>';
                        for (let j = 0; j < numInputs; j++) {
                            const val = (i >> (numInputs - 1 - j)) & 1;
                            values[inputs[j]] = val;
                            rowHtml += `<td class="border border-gray-300 p-1 text-center ${val ? 'bg-green-100 text-green-800' : 'bg-red-50 text-red-800'}">${val}</td>`;
                        }
                        const result = this.evaluateExpression(expression, values);
                        const resultClass = result === 1 ? 'bg-green-200 text-green-900' : (result === 0 ? 'bg-red-100 text-red-900' : 'bg-yellow-100 text-yellow-900');
                        rowHtml += `<td class="border border-gray-300 p-1 text-center font-bold ${resultClass}">${result === null ? '?' : result}</td></tr>`;
                        html += rowHtml;
                    }
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                }

                renderSnapshotList() {
                    const list = document.getElementById('snapshot-list');
                    const count = document.getElementById('snapshot-count');
                    const copyBtn = document.getElementById('snapshot-copy-btn');
                    
                    if (!list) return;

                    count.innerText = this.snapshotData.length;
                    if (this.snapshotData.length > 0) {
                        copyBtn.classList.remove('hidden');
                    } else {
                        copyBtn.classList.add('hidden');
                        list.innerHTML = `<div class="text-gray-500 text-center py-10 italic">No data captured. Click "Capture Current State".</div>`;
                        return;
                    }

                    let html = '';
                    let currentZone = '';

                    this.snapshotData.forEach((item, index) => {
                        if (item.zoneName !== currentZone) {
                            currentZone = item.zoneName;
                            html += `<div class="bg-gray-100 text-gray-700 px-3 py-2 font-bold text-sm border-t border-gray-200 mt-2 first:mt-0 sticky top-0 shadow-sm">${currentZone}</div>`;
                        }

                        html += `
                            <div class="flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50 transition-colors">
                                <div class="flex flex-col overflow-hidden">
                                    <div class="font-medium truncate text-gray-900">${item.deviceName}</div>
                                    <div class="text-xs text-gray-500 flex gap-2">
                                        <span class="bg-blue-50 px-1.5 rounded text-blue-700 border border-blue-100">${item.capabilityTitle}</span>
                                        <span class="text-green-600 font-mono font-bold">${String(item.value)}</span>
                                    </div>
                                </div>
                                <button onclick="app.removeSnapshotItem(${index})" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-full transition-colors" title="Remove from snapshot">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        `;
                    });

                    list.innerHTML = html;
                }

                removeSnapshotItem(index) {
                    this.snapshotData.splice(index, 1);
                    this.renderSnapshotList();
                }

                copySnapshotJSON() {
                    const output = {};
                    
                    this.snapshotData.forEach(item => {
                        if (!output[item.deviceId]) {
                            output[item.deviceId] = {};
                        }
                        output[item.deviceId][item.capabilityId] = item.value;
                    });

                    const jsonString = JSON.stringify(output);
                    
                    navigator.clipboard.writeText(jsonString).then(() => {
                        alert('JSON copied to clipboard! You can now paste this into a variable or flow card.');
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                        this.showOutputModal('Snapshot JSON', { json: output }, 'Copy the JSON below:');
                    });
                }
            }
            
            window.app = new BooleanToolboxApp();
        });
    </script>
</body>
</html>