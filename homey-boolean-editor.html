<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boolean Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .language-selector {
            position: relative;
        }
        .language-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            z-index: 50;
            min-width: 200px;
        }
        .language-dropdown.active {
            display: block;
        }
        .language-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s;
        }
        .language-option:hover {
            background: #4a5568;
        }
        .language-option:first-child {
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .language-option:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }
    </style>
    <script src="https://cdn.athom.com/homey-api/3.14.8.js"></script>
</head>
<body class="h-full">
    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto">
        
        <header class="flex flex-col md:flex-row justify-between items-center pb-6 border-b border-gray-700 mb-6">
            <div class="flex items-center space-x-4">
                 <img src="https://tiwas.github.io/HomeyBooleanToolbox/no.tiwas.booleantoolbox/assets/icon.svg" alt="Boolean Toolbox Logo" class="w-16 h-16 rounded-lg">
                 <div>
                    <h1 class="text-2xl font-bold text-white">Boolean Editor</h1>
                    <p class="text-gray-400 mt-1" data-i18n="subtitle">For Homey Boolean Toolbox</p>
                 </div>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <div class="language-selector">
                    <button id="language-button" class="flex items-center gap-2 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                        <span id="current-flag" class="text-xl">üá¨üáß</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="language-dropdown" class="language-dropdown">
                        <div class="language-option" data-lang="en">
                            <span class="text-xl">üá¨üáß</span>
                            <span>English</span>
                        </div>
                        <div class="language-option" data-lang="no">
                            <span class="text-xl">üá≥üá¥</span>
                            <span>Norsk</span>
                        </div>
                        <div class="language-option" data-lang="de">
                            <span class="text-xl">üá©üá™</span>
                            <span>Deutsch</span>
                        </div>
                        <div class="language-option" data-lang="fr">
                            <span class="text-xl">üá´üá∑</span>
                            <span>Fran√ßais</span>
                        </div>
                        <div class="language-option" data-lang="nl">
                            <span class="text-xl">üá≥üá±</span>
                            <span>Nederlands</span>
                        </div>
                    </div>
                </div>
                <div id="user-info" class="hidden text-right">
                    <p id="user-name" class="font-semibold"></p>
                    <p id="homey-name" class="text-sm text-gray-400"></p>
                    <button id="logout-button" class="text-sm text-red-400 hover:text-red-300" data-i18n="logout">Log out</button>
                </div>
            </div>
        </header>

        <main id="main-content" class="bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8">
            <div id="loader" class="screen active flex justify-center items-center p-16">
                <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <div id="login-screen" class="screen text-center p-16"></div>
            <div id="main-menu-screen" class="screen">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gray-700 p-6 rounded-lg hover:bg-gray-600 transition-colors cursor-pointer" onclick="app.showScreen('edit-devices-screen')">
                        <h3 class="text-lg font-semibold mb-2" data-i18n="menu.editDevices">Edit existing devices</h3>
                        <p class="text-gray-400" data-i18n="menu.editDevicesDesc">View and modify settings for devices created with Boolean Toolbox.</p>
                    </div>
                    <div class="bg-gray-700 p-6 rounded-lg hover:bg-gray-600 transition-colors cursor-pointer" onclick="app.showScreen('create-expression-step1-screen')">
                        <h3 class="text-lg font-semibold mb-2" data-i18n="menu.createExpression">Create new expression</h3>
                        <p class="text-gray-400" data-i18n="menu.createExpressionDesc">Select devices and capabilities to build a new boolean formula.</p>
                    </div>
                    <div class="bg-gray-700 p-6 rounded-lg hover:bg-gray-600 transition-colors cursor-pointer" onclick="app.showScreen('json-import-screen')">
                        <h3 class="text-lg font-semibold mb-2" data-i18n="menu.importJson">Import from JSON</h3>
                        <p class="text-gray-400" data-i18n="menu.importJsonDesc">Start with an existing expression by pasting JSON data.</p>
                    </div>
                </div>
            </div>
            <div id="edit-devices-screen" class="screen">
                <button class="mb-6 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" onclick="app.showScreen('main-menu-screen')">
                    <span data-i18n="back">‚Üê Back to menu</span>
                </button>
                <h2 class="text-xl font-bold mb-4" data-i18n="editDevices.title">Edit Boolean Toolbox Devices</h2>
                <div id="edit-devices-list" class="space-y-6"></div>
            </div>
            <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
                <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md shadow-2xl border border-gray-700">
                    <h3 id="settings-modal-title" class="text-lg font-bold mb-4" data-i18n="settings.title">Settings</h3>
                    <div id="settings-modal-content" class="space-y-4"></div>
                    <div class="mt-6 flex justify-end gap-4">
                        <button id="settings-modal-close" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" data-i18n="close">Close</button>
                        <button id="settings-modal-save" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" data-i18n="save">Save</button>
                    </div>
                </div>
            </div>
            <div id="create-expression-step1-screen" class="screen">
                <button class="mb-6 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" onclick="app.showScreen('main-menu-screen')">
                    <span data-i18n="back">‚Üê Back to menu</span>
                </button>
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="flex-grow">
                        <h2 class="text-xl font-bold mb-4" data-i18n="step1.title">Step 1: Select devices and capabilities</h2>
                        <p class="text-gray-400 mb-6" data-i18n="step1.description">Select between 2 and 10 capabilities to include in the expression.</p>
                        <div id="device-capability-list" class="space-y-6"></div>
                    </div>
                    <aside class="w-full lg:w-1/3 lg:sticky top-8 self-start bg-gray-900 p-6 rounded-lg border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">
                            <span data-i18n="step1.selected">Selected capabilities</span> (<span id="selected-count">0</span>/10)
                        </h3>
                        <ul id="selected-capabilities-list" class="space-y-2 mb-6 h-64 overflow-y-auto"></ul>
                        <button id="next-step-button" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" disabled data-i18n="next">Next ‚Üí</button>
                    </aside>
                </div>
            </div>
            <div id="create-expression-step2-screen" class="screen">
                <button class="mb-6 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" onclick="app.showScreen('create-expression-step1-screen')">
                    <span data-i18n="backToSelection">‚Üê Back to selection</span>
                </button>
                <h2 class="text-xl font-bold mb-4" data-i18n="step2.title">Step 2: Build boolean formula</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-2" data-i18n="step2.yourVariables">Your selected variables:</h3>
                        <ul id="variable-mapping-list" class="space-y-1 bg-gray-900 p-4 rounded-lg border border-gray-700"></ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2" data-i18n="step2.formulaEditor">Formula editor</h3>
                        <p class="text-sm text-gray-400 mb-2" data-i18n="step2.formulaHelp">Use variables A-J and operators AND, OR, NOT, XOR and parentheses ().</p>
                        <textarea id="formula-input" class="w-full h-48 p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 font-mono" placeholder="(A AND B) OR NOT C"></textarea>
                        <button class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" data-i18n="saveExpression">Save expression</button>
                    </div>
                </div>
            </div>
            <div id="json-import-screen" class="screen">
                <button class="mb-6 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" onclick="app.showScreen('main-menu-screen')">
                    <span data-i18n="back">‚Üê Back to menu</span>
                </button>
                <h2 class="text-xl font-bold mb-4" data-i18n="import.title">Import from JSON</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2" data-i18n="import.devicesTitle">Devices and capabilities</h3>
                        <p class="text-sm text-gray-400 mb-2" data-i18n="import.devicesHelp">Paste a JSON array with objects containing 'deviceId' and 'capabilityId'.</p>
                        <textarea id="json-devices-input" class="w-full h-48 p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 font-mono" placeholder='[{"deviceId": "...", "capabilityId": "..."}, ...]'></textarea>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2" data-i18n="import.formulaTitle">Formula (optional)</h3>
                        <p class="text-sm text-gray-400 mb-2" data-i18n="import.formulaHelp">Paste the boolean formula as text.</p>
                        <textarea id="json-formula-input" class="w-full h-24 p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 font-mono" placeholder="(A AND B) OR NOT C"></textarea>
                    </div>
                    <button id="json-import-button" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg" data-i18n="import.button">Import and continue</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const translations = {
            en: {
                subtitle: "For Homey Boolean Toolbox",
                logout: "Log out",
                back: "‚Üê Back to menu",
                backToSelection: "‚Üê Back to selection",
                close: "Close",
                save: "Save",
                next: "Next ‚Üí",
                menu: {
                    editDevices: "Edit existing devices",
                    editDevicesDesc: "View and modify settings for devices created with Boolean Toolbox.",
                    createExpression: "Create new expression",
                    createExpressionDesc: "Select devices and capabilities to build a new boolean formula.",
                    importJson: "Import from JSON",
                    importJsonDesc: "Start with an existing expression by pasting JSON data."
                },
                editDevices: {
                    title: "Edit Boolean Toolbox Devices",
                    noDevices: "No devices found from Boolean Toolbox.",
                    settings: "Settings"
                },
                settings: {
                    title: "Settings",
                    titleFor: "Settings for",
                    loading: "Loading settings...",
                    noSettings: "This device has no settings.",
                    saved: "Settings saved!",
                    error: "Could not save settings:"
                },
                step1: {
                    title: "Step 1: Select devices and capabilities",
                    description: "Select between 2 and 10 capabilities to include in the expression.",
                    selected: "Selected capabilities",
                    noneSelected: "None selected",
                    maxCapabilities: "You can select a maximum of 10 capabilities."
                },
                step2: {
                    title: "Step 2: Build boolean formula",
                    yourVariables: "Your selected variables:",
                    formulaEditor: "Formula editor",
                    formulaHelp: "Use variables A-J and operators AND, OR, NOT, XOR and parentheses ().",
                    saveExpression: "Save expression"
                },
                import: {
                    title: "Import from JSON",
                    devicesTitle: "Devices and capabilities",
                    devicesHelp: "Paste a JSON array with objects containing 'deviceId' and 'capabilityId'.",
                    formulaTitle: "Formula (optional)",
                    formulaHelp: "Paste the boolean formula as text.",
                    button: "Import and continue",
                    errorEmpty: "You must paste JSON for devices.",
                    errorRange: "JSON must be a list with 2 to 10 devices.",
                    errorParsing: "Error parsing JSON:"
                },
                login: {
                    welcome: "Welcome!",
                    message: "To continue, you need to log in with your Homey account.",
                    button: "Log in with Homey"
                },
                errors: {
                    startApp: "Could not start the app:",
                    noHomey: "No Homey found for this account.",
                    afterLogin: "An error occurred after login:",
                    fetchData: "Could not fetch data from Homey:",
                    authFailed: "Authentication failed:",
                    deviceNotFound: "Device with ID {id} not found",
                    capabilityNotFound: "Capability {cap} not found on device {device}"
                }
            },
            no: {
                subtitle: "For Homey Boolean Toolbox",
                logout: "Logg ut",
                back: "‚Üê Tilbake til meny",
                backToSelection: "‚Üê Tilbake til valg",
                close: "Lukk",
                save: "Lagre",
                next: "Neste ‚Üí",
                menu: {
                    editDevices: "Rediger eksisterende enheter",
                    editDevicesDesc: "Se og endre innstillinger for enheter opprettet med Boolean Toolbox.",
                    createExpression: "Lag nytt uttrykk",
                    createExpressionDesc: "Velg enheter og kapabiliteter for √• bygge en ny boolsk formel.",
                    importJson: "Importer fra JSON",
                    importJsonDesc: "Start med et eksisterende uttrykk ved √• lime inn JSON-data."
                },
                editDevices: {
                    title: "Rediger Boolean Toolbox Enheter",
                    noDevices: "Ingen enheter funnet fra Boolean Toolbox.",
                    settings: "Innstillinger"
                },
                settings: {
                    title: "Innstillinger",
                    titleFor: "Innstillinger for",
                    loading: "Laster innstillinger...",
                    noSettings: "Denne enheten har ingen innstillinger.",
                    saved: "Innstillinger lagret!",
                    error: "Kunne ikke lagre innstillinger:"
                },
                step1: {
                    title: "Steg 1: Velg enheter og kapabiliteter",
                    description: "Velg mellom 2 og 10 kapabiliteter som skal inng√• i uttrykket.",
                    selected: "Valgte kapabiliteter",
                    noneSelected: "Ingen valgt",
                    maxCapabilities: "Du kan maksimalt velge 10 kapabiliteter."
                },
                step2: {
                    title: "Steg 2: Bygg boolsk formel",
                    yourVariables: "Dine valgte variabler:",
                    formulaEditor: "Formel-editor",
                    formulaHelp: "Bruk variablene A-J og operatorene AND, OR, NOT, XOR og parenteser ().",
                    saveExpression: "Lagre uttrykk"
                },
                import: {
                    title: "Importer fra JSON",
                    devicesTitle: "Enheter og kapabiliteter",
                    devicesHelp: "Lim inn en JSON-array med objekter som har 'deviceId' og 'capabilityId'.",
                    formulaTitle: "Formel (valgfritt)",
                    formulaHelp: "Lim inn den boolske formelen som tekst.",
                    button: "Importer og fortsett",
                    errorEmpty: "Du m√• lime inn JSON for enheter.",
                    errorRange: "JSON m√• v√¶re en liste med 2 til 10 enheter.",
                    errorParsing: "Feil ved parsing av JSON:"
                },
                login: {
                    welcome: "Velkommen!",
                    message: "For √• fortsette m√• du logge inn med din Homey-konto.",
                    button: "Logg inn med Homey"
                },
                errors: {
                    startApp: "Klarte ikke √• starte appen:",
                    noHomey: "Ingen Homey funnet for denne kontoen.",
                    afterLogin: "En feil oppstod etter innlogging:",
                    fetchData: "Kunne ikke hente data fra Homey:",
                    authFailed: "Autentisering feilet:",
                    deviceNotFound: "Enhet med ID {id} ikke funnet",
                    capabilityNotFound: "Kapabilitet {cap} ikke funnet p√• enhet {device}"
                }
            },
            de: {
                subtitle: "F√ºr Homey Boolean Toolbox",
                logout: "Abmelden",
                back: "‚Üê Zur√ºck zum Men√º",
                backToSelection: "‚Üê Zur√ºck zur Auswahl",
                close: "Schlie√üen",
                save: "Speichern",
                next: "Weiter ‚Üí",
                menu: {
                    editDevices: "Vorhandene Ger√§te bearbeiten",
                    editDevicesDesc: "Einstellungen f√ºr mit Boolean Toolbox erstellte Ger√§te anzeigen und √§ndern.",
                    createExpression: "Neuen Ausdruck erstellen",
                    createExpressionDesc: "W√§hlen Sie Ger√§te und Funktionen aus, um eine neue boolesche Formel zu erstellen.",
                    importJson: "Aus JSON importieren",
                    importJsonDesc: "Beginnen Sie mit einem vorhandenen Ausdruck, indem Sie JSON-Daten einf√ºgen."
                },
                editDevices: {
                    title: "Boolean Toolbox Ger√§te bearbeiten",
                    noDevices: "Keine Ger√§te von Boolean Toolbox gefunden.",
                    settings: "Einstellungen"
                },
                settings: {
                    title: "Einstellungen",
                    titleFor: "Einstellungen f√ºr",
                    loading: "Lade Einstellungen...",
                    noSettings: "Dieses Ger√§t hat keine Einstellungen.",
                    saved: "Einstellungen gespeichert!",
                    error: "Einstellungen konnten nicht gespeichert werden:"
                },
                step1: {
                    title: "Schritt 1: Ger√§te und Funktionen ausw√§hlen",
                    description: "W√§hlen Sie zwischen 2 und 10 Funktionen aus, die in den Ausdruck aufgenommen werden sollen.",
                    selected: "Ausgew√§hlte Funktionen",
                    noneSelected: "Keine ausgew√§hlt",
                    maxCapabilities: "Sie k√∂nnen maximal 10 Funktionen ausw√§hlen."
                },
                step2: {
                    title: "Schritt 2: Boolesche Formel erstellen",
                    yourVariables: "Ihre ausgew√§hlten Variablen:",
                    formulaEditor: "Formel-Editor",
                    formulaHelp: "Verwenden Sie Variablen A-J und Operatoren AND, OR, NOT, XOR sowie Klammern ().",
                    saveExpression: "Ausdruck speichern"
                },
                import: {
                    title: "Aus JSON importieren",
                    devicesTitle: "Ger√§te und Funktionen",
                    devicesHelp: "F√ºgen Sie ein JSON-Array mit Objekten ein, die 'deviceId' und 'capabilityId' enthalten.",
                    formulaTitle: "Formel (optional)",
                    formulaHelp: "F√ºgen Sie die boolesche Formel als Text ein.",
                    button: "Importieren und fortfahren",
                    errorEmpty: "Sie m√ºssen JSON f√ºr Ger√§te einf√ºgen.",
                    errorRange: "JSON muss eine Liste mit 2 bis 10 Ger√§ten sein.",
                    errorParsing: "Fehler beim Parsen von JSON:"
                },
                login: {
                    welcome: "Willkommen!",
                    message: "Um fortzufahren, m√ºssen Sie sich mit Ihrem Homey-Konto anmelden.",
                    button: "Mit Homey anmelden"
                },
                errors: {
                    startApp: "App konnte nicht gestartet werden:",
                    noHomey: "Kein Homey f√ºr dieses Konto gefunden.",
                    afterLogin: "Nach der Anmeldung ist ein Fehler aufgetreten:",
                    fetchData: "Daten konnten nicht von Homey abgerufen werden:",
                    authFailed: "Authentifizierung fehlgeschlagen:",
                    deviceNotFound: "Ger√§t mit ID {id} nicht gefunden",
                    capabilityNotFound: "Funktion {cap} auf Ger√§t {device} nicht gefunden"
                }
            },
            fr: {
                subtitle: "Pour Homey Boolean Toolbox",
                logout: "Se d√©connecter",
                back: "‚Üê Retour au menu",
                backToSelection: "‚Üê Retour √† la s√©lection",
                close: "Fermer",
                save: "Enregistrer",
                next: "Suivant ‚Üí",
                menu: {
                    editDevices: "Modifier les appareils existants",
                    editDevicesDesc: "Afficher et modifier les param√®tres des appareils cr√©√©s avec Boolean Toolbox.",
                    createExpression: "Cr√©er une nouvelle expression",
                    createExpressionDesc: "S√©lectionnez des appareils et des capacit√©s pour cr√©er une nouvelle formule bool√©enne.",
                    importJson: "Importer depuis JSON",
                    importJsonDesc: "Commencez avec une expression existante en collant des donn√©es JSON."
                },
                editDevices: {
                    title: "Modifier les appareils Boolean Toolbox",
                    noDevices: "Aucun appareil trouv√© dans Boolean Toolbox.",
                    settings: "Param√®tres"
                },
                settings: {
                    title: "Param√®tres",
                    titleFor: "Param√®tres pour",
                    loading: "Chargement des param√®tres...",
                    noSettings: "Cet appareil n'a pas de param√®tres.",
                    saved: "Param√®tres enregistr√©s!",
                    error: "Impossible d'enregistrer les param√®tres:"
                },
                step1: {
                    title: "√âtape 1: S√©lectionner les appareils et capacit√©s",
                    description: "S√©lectionnez entre 2 et 10 capacit√©s √† inclure dans l'expression.",
                    selected: "Capacit√©s s√©lectionn√©es",
                    noneSelected: "Aucune s√©lectionn√©e",
                    maxCapabilities: "Vous pouvez s√©lectionner un maximum de 10 capacit√©s."
                },
                step2: {
                    title: "√âtape 2: Cr√©er une formule bool√©enne",
                    yourVariables: "Vos variables s√©lectionn√©es:",
                    formulaEditor: "√âditeur de formule",
                    formulaHelp: "Utilisez les variables A-J et les op√©rateurs AND, OR, NOT, XOR et les parenth√®ses ().",
                    saveExpression: "Enregistrer l'expression"
                },
                import: {
                    title: "Importer depuis JSON",
                    devicesTitle: "Appareils et capacit√©s",
                    devicesHelp: "Collez un tableau JSON avec des objets contenant 'deviceId' et 'capabilityId'.",
                    formulaTitle: "Formule (optionnel)",
                    formulaHelp: "Collez la formule bool√©enne sous forme de texte.",
                    button: "Importer et continuer",
                    errorEmpty: "Vous devez coller du JSON pour les appareils.",
                    errorRange: "Le JSON doit √™tre une liste de 2 √† 10 appareils.",
                    errorParsing: "Erreur lors de l'analyse du JSON:"
                },
                login: {
                    welcome: "Bienvenue!",
                    message: "Pour continuer, vous devez vous connecter avec votre compte Homey.",
                    button: "Se connecter avec Homey"
                },
                errors: {
                    startApp: "Impossible de d√©marrer l'application:",
                    noHomey: "Aucun Homey trouv√© pour ce compte.",
                    afterLogin: "Une erreur s'est produite apr√®s la connexion:",
                    fetchData: "Impossible de r√©cup√©rer les donn√©es de Homey:",
                    authFailed: "√âchec de l'authentification:",
                    deviceNotFound: "Appareil avec l'ID {id} introuvable",
                    capabilityNotFound: "Capacit√© {cap} introuvable sur l'appareil {device}"
                }
            },
            nl: {
                subtitle: "Voor Homey Boolean Toolbox",
                logout: "Uitloggen",
                back: "‚Üê Terug naar menu",
                backToSelection: "‚Üê Terug naar selectie",
                close: "Sluiten",
                save: "Opslaan",
                next: "Volgende ‚Üí",
                menu: {
                    editDevices: "Bestaande apparaten bewerken",
                    editDevicesDesc: "Bekijk en wijzig instellingen voor apparaten gemaakt met Boolean Toolbox.",
                    createExpression: "Nieuwe expressie maken",
                    createExpressionDesc: "Selecteer apparaten en mogelijkheden om een nieuwe booleaanse formule te maken.",
                    importJson: "Importeren vanuit JSON",
                    importJsonDesc: "Begin met een bestaande expressie door JSON-gegevens te plakken."
                },
                editDevices: {
                    title: "Boolean Toolbox Apparaten bewerken",
                    noDevices: "Geen apparaten gevonden van Boolean Toolbox.",
                    settings: "Instellingen"
                },
                settings: {
                    title: "Instellingen",
                    titleFor: "Instellingen voor",
                    loading: "Instellingen laden...",
                    noSettings: "Dit apparaat heeft geen instellingen.",
                    saved: "Instellingen opgeslagen!",
                    error: "Kon instellingen niet opslaan:"
                },
                step1: {
                    title: "Stap 1: Selecteer apparaten en mogelijkheden",
                    description: "Selecteer tussen 2 en 10 mogelijkheden om op te nemen in de expressie.",
                    selected: "Geselecteerde mogelijkheden",
                    noneSelected: "Geen geselecteerd",
                    maxCapabilities: "U kunt maximaal 10 mogelijkheden selecteren."
                },
                step2: {
                    title: "Stap 2: Bouw booleaanse formule",
                    yourVariables: "Uw geselecteerde variabelen:",
                    formulaEditor: "Formule-editor",
                    formulaHelp: "Gebruik variabelen A-J en operatoren AND, OR, NOT, XOR en haakjes ().",
                    saveExpression: "Expressie opslaan"
                },
                import: {
                    title: "Importeren vanuit JSON",
                    devicesTitle: "Apparaten en mogelijkheden",
                    devicesHelp: "Plak een JSON-array met objecten die 'deviceId' en 'capabilityId' bevatten.",
                    formulaTitle: "Formule (optioneel)",
                    formulaHelp: "Plak de booleaanse formule als tekst.",
                    button: "Importeren en doorgaan",
                    errorEmpty: "U moet JSON voor apparaten plakken.",
                    errorRange: "JSON moet een lijst zijn met 2 tot 10 apparaten.",
                    errorParsing: "Fout bij het parseren van JSON:"
                },
                login: {
                    welcome: "Welkom!",
                    message: "Om door te gaan, moet u inloggen met uw Homey-account.",
                    button: "Inloggen met Homey"
                },
                errors: {
                    startApp: "Kon de app niet starten:",
                    noHomey: "Geen Homey gevonden voor dit account.",
                    afterLogin: "Er is een fout opgetreden na het inloggen:",
                    fetchData: "Kon geen gegevens ophalen van Homey:",
                    authFailed: "Authenticatie mislukt:",
                    deviceNotFound: "Apparaat met ID {id} niet gevonden",
                    capabilityNotFound: "Mogelijkheid {cap} niet gevonden op apparaat {device}"
                }
            }
        };

        const flags = {
            en: 'üá¨üáß',
            no: 'üá≥üá¥',
            de: 'üá©üá™',
            fr: 'üá´üá∑',
            nl: 'üá≥üá±'
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            class BooleanToolboxApp {
                CLIENT_ID = null;
                cloudApi = null;
                authenticatedUser = null;
                homey = null;
                api = null;
                allDevices = {};
                allZones = {};
                selectedCapabilities = [];
                processingAuth = false;
                currentLang = 'en';

                constructor() {
                    this.currentLang = localStorage.getItem('language') || 'en';
                    this.init();
                    this.initLanguageSelector();
                }

                initLanguageSelector() {
                    const languageButton = document.getElementById('language-button');
                    const languageDropdown = document.getElementById('language-dropdown');
                    const currentFlag = document.getElementById('current-flag');
                    
                    languageButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        languageDropdown.classList.toggle('active');
                    });

                    document.addEventListener('click', () => {
                        languageDropdown.classList.remove('active');
                    });

                    document.querySelectorAll('.language-option').forEach(option => {
                        option.addEventListener('click', (e) => {
                            const lang = e.currentTarget.dataset.lang;
                            this.setLanguage(lang);
                            languageDropdown.classList.remove('active');
                        });
                    });

                    currentFlag.textContent = flags[this.currentLang];
                    this.updateTranslations();
                }

                setLanguage(lang) {
                    this.currentLang = lang;
                    localStorage.setItem('language', lang);
                    document.getElementById('current-flag').textContent = flags[lang];
                    this.updateTranslations();
                    
                    // Re-render dynamic content
                    if (this.allDevices && Object.keys(this.allDevices).length > 0) {
                        this.renderAll();
                    }
                    this.renderSelectedCapabilities();
                    this.renderLoginScreen();
                }

                t(key) {
                    const keys = key.split('.');
                    let value = translations[this.currentLang];
                    for (const k of keys) {
                        value = value?.[k];
                    }
                    return value || key;
                }

                updateTranslations() {
                    document.querySelectorAll('[data-i18n]').forEach(element => {
                        const key = element.getAttribute('data-i18n');
                        element.textContent = this.t(key);
                    });
                }

                async init() {
                    try {
                        if (typeof AthomCloudAPI === 'undefined') {
                            throw new Error("AthomCloudAPI script did not load correctly. Please check your internet connection and ad-blockers.");
                        }

                        const response = await fetch('/api/get-config');
                        if (!response.ok) throw new Error(`Failed to fetch config: ${response.statusText}`);
                        
                        const config = await response.json();
                        if (!config.clientId) throw new Error('Could not get clientId from config.');
                        this.CLIENT_ID = config.clientId;

                        this.cloudApi = new AthomCloudAPI({ clientId: this.CLIENT_ID });
                        this.setupEventListeners();
                        this.renderLoginScreen();

                        const urlParams = new URLSearchParams(window.location.search);
                        const code = urlParams.get('code');

                        if (code) {
                            await this.handleAuthRedirect(code);
                        } else if (await this.cloudApi.isLoggedIn()) {
                            await this.postLogin();
                        } else {
                            this.showScreen('login-screen');
                        }
                    } catch (error) {
                        console.error("Initialization failed:", error);
                        this.showError(this.t('errors.startApp') + ' ' + error.message);
                    }
                }
                
                setupEventListeners() {
                    document.getElementById('main-content').addEventListener('click', (event) => {
                        if (event.target.id === 'login-button') this.login();
                    });
                    document.getElementById('logout-button').addEventListener('click', () => this.logout());
                    document.getElementById('next-step-button').addEventListener('click', () => this.showScreen('create-expression-step2-screen'));
                    document.getElementById('json-import-button').addEventListener('click', () => this.handleJsonImport());
                    document.getElementById('settings-modal-close').addEventListener('click', () => this.closeSettingsModal());
                    document.getElementById('settings-modal-save').addEventListener('click', () => this.saveSettings());
                }

                async login() {
                    if (!this.CLIENT_ID) return this.showError("Client ID mangler. Kan ikke starte innlogging.");
                    const redirectUrl = 'https://homey-boolean-toolbox.vercel.app/';
                    const authorizationUrl = `https://api.athom.com/oauth2/authorise?response_type=code&client_id=${this.CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUrl)}`;
                    window.location.href = authorizationUrl;
                }

                async handleAuthRedirect(code) {
                    if (this.processingAuth) {
                        console.log('Already processing auth, skipping...');
                        return;
                    }
                    this.processingAuth = true;
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    this.showScreen('loader');
                    try {
                        const redirectUrl = 'https://homey-boolean-toolbox.vercel.app/';
                        
                        console.log('Fetching token from server...');
                        const response = await fetch('/api/get-token', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: code, redirectUrl: redirectUrl }),
                        });
                        
                        const responseText = await response.text();
                        console.log('Token response:', response.status);
                        
                        if (!response.ok) {
                            let errorDetails = responseText;
                            try {
                                const errorJson = JSON.parse(responseText);
                                errorDetails = errorJson.error_description || errorJson.error || JSON.stringify(errorJson);
                            } catch(e) { /* Ignore parsing error */ }
                            throw new Error(`Server responded with ${response.status}: ${errorDetails}`);
                        }
                        
                        const tokenData = JSON.parse(responseText);
                        console.log('Token received, has access_token:', !!tokenData.access_token);
                        
                        // Store token in the format AthomCloudAPI expects
                        const tokenKey = `com.athom.cloudapi.token.${this.CLIENT_ID}`;
                        localStorage.setItem(tokenKey, JSON.stringify({
                            access_token: tokenData.access_token,
                            refresh_token: tokenData.refresh_token,
                            expires_in: tokenData.expires_in,
                            token_type: tokenData.token_type || 'Bearer'
                        }));
                        
                        console.log('Token stored in localStorage');
                        
                        // Reinitialize AthomCloudAPI so it picks up the token
                        this.cloudApi = new AthomCloudAPI({ clientId: this.CLIENT_ID });
                        
                        console.log('Proceeding to postLogin...');
                        await this.postLogin();
                    } catch (error) {
                        console.error('Auth error:', error);
                        this.showError(this.t('errors.authFailed') + ' ' + error.message);
                    } finally {
                        this.processingAuth = false;
                    }
                }
                
                async logout() {
                    try { 
                        await this.cloudApi.logout(); 
                    } catch(e) { 
                        console.error("Logout failed, continuing.", e); 
                    }
                    
                    // Clear token from localStorage using the correct key
                    const tokenKey = `com.athom.cloudapi.token.${this.CLIENT_ID}`;
                    localStorage.removeItem(tokenKey);
                    
                    this.authenticatedUser = null; 
                    this.homey = null; 
                    this.api = null;
                    document.getElementById('user-info').classList.add('hidden');
                    this.renderLoginScreen();
                    this.showScreen('login-screen');
                }

                async postLogin() {
                    try {
                        this.authenticatedUser = await this.cloudApi.getAuthenticatedUser();
                        const homeys = await this.authenticatedUser.getHomeys();
                        this.homey = homeys[0];
                        if (!this.homey) throw new Error(this.t('errors.noHomey'));
                        
                        await this.homey.authenticate();
                        this.api = await this.homey.getApi();

                        document.getElementById('user-name').textContent = this.authenticatedUser.nickname;
                        document.getElementById('homey-name').textContent = `Homey: ${this.homey.name}`;
                        document.getElementById('user-info').classList.remove('hidden');

                        await this.fetchData();
                        this.renderAll();
                        this.showScreen('main-menu-screen');
                    } catch (error) {
                        console.error(error);
                        this.showError(this.t('errors.afterLogin') + ' ' + error.message);
                        await this.logout();
                    }
                }

                async fetchData() {
                    this.showScreen('loader');
                    try {
                        [this.allDevices, this.allZones] = await Promise.all([
                            this.api.devices.getDevices(),
                            this.api.zones.getZones()
                        ]);
                    } catch (error) { this.showError(this.t('errors.fetchData') + ' ' + error.message); }
                }

                renderAll() { this.renderEditDevices(); this.renderDeviceCapabilityList(); }
                
                renderEditDevices() {
                    const container = document.getElementById('edit-devices-list');
                    container.innerHTML = '';
                    const toolboxDevices = Object.values(this.allDevices).filter(d => d.driverId.startsWith('booleantoolbox'));
                    if (toolboxDevices.length === 0) {
                         container.innerHTML = `<div class="bg-gray-700 p-4 rounded-lg text-center text-gray-400">${this.t('editDevices.noDevices')}</div>`;
                         return;
                    }
                    const devicesByZone = this.groupDevicesByZone(toolboxDevices);
                    const sortedZones = this.sortZones(Object.keys(devicesByZone));
                    sortedZones.forEach(zoneId => {
                        if (!devicesByZone[zoneId]) return;
                        const zone = this.allZones[zoneId];
                        const zoneDevices = devicesByZone[zoneId];
                        const zoneEl = document.createElement('div');
                        zoneEl.innerHTML = `<h3 class="text-lg font-semibold border-b border-gray-600 pb-2 mb-4">${zone.name}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${zoneDevices.map(device => `<div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center"><span class="font-medium">${device.name}</span><button data-device-id="${device.id}" class="open-settings-button bg-gray-600 hover:bg-gray-500 text-white text-sm py-1 px-3 rounded-md">${this.t('editDevices.settings')}</button></div>`).join('')}</div>`;
                        container.appendChild(zoneEl);
                    });
                    container.querySelectorAll('.open-settings-button').forEach(button => button.addEventListener('click', (e) => this.openSettingsModal(e.target.dataset.deviceId)));
                }

                renderDeviceCapabilityList() {
                    const container = document.getElementById('device-capability-list');
                    container.innerHTML = '';
                    const devicesByZone = this.groupDevicesByZone(Object.values(this.allDevices));
                    const sortedZones = this.sortZones(Object.keys(devicesByZone));
                    sortedZones.forEach(zoneId => {
                        if (!devicesByZone[zoneId] || !this.allZones[zoneId]) return;
                        const zone = this.allZones[zoneId];
                        const zoneDevices = devicesByZone[zoneId];
                        const zoneEl = document.createElement('div');
                        zoneEl.innerHTML = `<h3 class="text-lg font-semibold border-b border-gray-600 pb-2 mb-4">${zone.name}</h3>`;
                        const deviceListEl = document.createElement('div');
                        deviceListEl.className = 'space-y-4';
                        zoneEl.appendChild(deviceListEl);
                        zoneDevices.forEach(device => {
                            if (!device.capabilitiesObj || Object.keys(device.capabilitiesObj).length === 0) return;
                            const deviceEl = document.createElement('div');
                            deviceEl.className = 'bg-gray-700 p-4 rounded-lg';
                            deviceEl.innerHTML = `<p class="font-semibold mb-3">${device.name}</p><div class="space-y-2">${Object.values(device.capabilitiesObj).map(cap => `<label class="flex items-center space-x-3 cursor-pointer"><input type="checkbox" data-device-id="${device.id}" data-capability-id="${cap.id}" class="capability-checkbox form-checkbox h-5 w-5 rounded bg-gray-600 border-gray-500 text-blue-500 focus:ring-blue-500"><span class="text-gray-300">${cap.title}</span></label>`).join('')}</div>`;
                            deviceListEl.appendChild(deviceEl);
                        });
                        container.appendChild(zoneEl);
                    });
                    container.querySelectorAll('.capability-checkbox').forEach(checkbox => checkbox.addEventListener('change', (e) => this.handleCapabilitySelection(e.target)));
                }
                
                renderSelectedCapabilities() {
                    const list = document.getElementById('selected-capabilities-list');
                    const countEl = document.getElementById('selected-count');
                    const nextButton = document.getElementById('next-step-button');
                    list.innerHTML = '';
                    countEl.textContent = this.selectedCapabilities.length;
                    if (this.selectedCapabilities.length === 0) list.innerHTML = `<li class="text-gray-500 text-center italic">${this.t('step1.noneSelected')}</li>`;
                    this.selectedCapabilities.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-700 p-2 rounded-md flex justify-between items-center text-sm';
                        li.innerHTML = `<span class="truncate"><span class="font-bold">${String.fromCharCode(65 + index)}:</span> ${item.deviceName} - ${item.capabilityTitle}</span><button data-index="${index}" class="remove-capability-btn text-red-400 hover:text-red-300 p-1 font-bold text-lg">&times;</button>`;
                        list.appendChild(li);
                    });
                    list.querySelectorAll('.remove-capability-btn').forEach(btn => btn.addEventListener('click', e => this.removeCapability(parseInt(e.currentTarget.dataset.index))));
                    const count = this.selectedCapabilities.length;
                    nextButton.disabled = !(count >= 2 && count <= 10);
                }
                
                renderVariableMapping() {
                     const list = document.getElementById('variable-mapping-list');
                     list.innerHTML = '';
                     this.selectedCapabilities.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = 'text-gray-300';
                        li.innerHTML = `<span class="font-mono font-bold text-blue-400">${String.fromCharCode(65 + index)}:</span> ${item.deviceName} <span class="text-gray-500">(${item.capabilityTitle})</span>`;
                        list.appendChild(li);
                     });
                }

                handleCapabilitySelection(checkbox) {
                    const { deviceId, capabilityId } = checkbox.dataset;
                    const device = this.allDevices[deviceId];
                    const capability = device.capabilitiesObj[capabilityId];
                    if (checkbox.checked) {
                        if (this.selectedCapabilities.length < 10) this.selectedCapabilities.push({ deviceId, capabilityId, deviceName: device.name, capabilityTitle: capability.title });
                        else { checkbox.checked = false; alert(this.t('step1.maxCapabilities')); }
                    } else {
                        this.selectedCapabilities = this.selectedCapabilities.filter(item => !(item.deviceId === deviceId && item.capabilityId === capabilityId));
                    }
                    this.renderSelectedCapabilities();
                }
                
                removeCapability(index) {
                    const [removedItem] = this.selectedCapabilities.splice(index, 1);
                    const checkbox = document.querySelector(`input[data-device-id="${removedItem.deviceId}"][data-capability-id="${removedItem.capabilityId}"]`);
                    if (checkbox) checkbox.checked = false;
                    this.renderSelectedCapabilities();
                }
                
                async handleJsonImport() {
                    const devicesJson = document.getElementById('json-devices-input').value;
                    const formula = document.getElementById('json-formula-input').value;
                    if (!devicesJson) return alert(this.t('import.errorEmpty'));
                    try {
                        const parsedDevices = JSON.parse(devicesJson);
                        if (!Array.isArray(parsedDevices) || parsedDevices.length < 2 || parsedDevices.length > 10) return alert(this.t('import.errorRange'));
                        this.selectedCapabilities = parsedDevices.map(item => {
                            const device = this.allDevices[item.deviceId];
                            if (!device) throw new Error(this.t('errors.deviceNotFound').replace('{id}', item.deviceId));
                            const capability = device.capabilitiesObj[item.capabilityId];
                            if (!capability) throw new Error(this.t('errors.capabilityNotFound').replace('{cap}', item.capabilityId).replace('{device}', device.name));
                            return { deviceId: item.deviceId, capabilityId: item.capabilityId, deviceName: device.name, capabilityTitle: capability.title };
                        });
                        this.renderSelectedCapabilities();
                        if (formula) document.getElementById('formula-input').value = formula;
                        this.showScreen('create-expression-step2-screen');
                    } catch (error) { alert(this.t('import.errorParsing') + ' ' + error.message); }
                }
                
                async openSettingsModal(deviceId) {
                    const device = this.allDevices[deviceId];
                    if (!device) return;
                    const modal = document.getElementById('settings-modal');
                    const title = document.getElementById('settings-modal-title');
                    const content = document.getElementById('settings-modal-content');
                    const saveBtn = document.getElementById('settings-modal-save');
                    title.textContent = `${this.t('settings.titleFor')} ${device.name}`;
                    content.innerHTML = `<p>${this.t('settings.loading')}</p>`;
                    saveBtn.dataset.deviceId = deviceId;
                    modal.style.display = 'flex';
                    try {
                        const settings = await this.api.devices.getDeviceSettings({ id: deviceId });
                        let settingsHtml = '';
                        for (const key in settings) {
                            settingsHtml += `<div><label for="setting-${key}" class="block text-sm font-medium text-gray-300">${key}</label><input type="text" id="setting-${key}" data-key="${key}" class="mt-1 block w-full p-2 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500" value="${settings[key]}"></div>`;
                        }
                        content.innerHTML = settingsHtml || `<p>${this.t('settings.noSettings')}</p>`;
                    } catch(error) { content.innerHTML = `<p class="text-red-400">${this.t('settings.error')} ${error.message}</p>`; }
                }

                closeSettingsModal() { document.getElementById('settings-modal').style.display = 'none'; }

                async saveSettings() {
                    const deviceId = document.getElementById('settings-modal-save').dataset.deviceId;
                    const content = document.getElementById('settings-modal-content');
                    const inputs = content.querySelectorAll('input');
                    const newSettings = {};
                    inputs.forEach(input => { newSettings[input.dataset.key] = input.value; });
                    try {
                        await this.api.devices.updateDeviceSettings({ id: deviceId, data: newSettings });
                        alert(this.t('settings.saved'));
                        this.closeSettingsModal();
                    } catch (error) { alert(this.t('settings.error') + ' ' + error.message); }
                }

                renderLoginScreen() {
                     document.getElementById('login-screen').innerHTML = `<h2 class="text-xl font-bold mb-4">${this.t('login.welcome')}</h2><p class="mb-6 text-gray-300">${this.t('login.message')}</p><button id="login-button" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">${this.t('login.button')}</button>`;
                }

                showScreen(screenId) {
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    const screen = document.getElementById(screenId);
                    if (screen) screen.classList.add('active');
                    if (screenId === 'create-expression-step2-screen') this.renderVariableMapping();
                }
                
                showError(message) {
                    const loginScreen = document.getElementById('login-screen');
                    loginScreen.innerHTML = `<p class="text-red-400 p-4 bg-red-900/50 rounded-lg">${message}</p>`;
                    this.showScreen('login-screen');
                }

                groupDevicesByZone(deviceList) {
                    return deviceList.reduce((acc, device) => {
                        const zone = device.zone;
                        if (!acc[zone]) acc[zone] = [];
                        acc[zone].push(device);
                        return acc;
                    }, {});
                }

                sortZones(zoneIds) {
                    const homeZoneId = Object.keys(this.allZones).find(id => {
                         if (!this.allZones[id]) return false;
                         return ['home', 'hjem', 'zuhause', 'maison', 'casa'].includes(this.allZones[id].name.toLowerCase())
                    });
                    return zoneIds.sort((a, b) => {
                        if (a === homeZoneId) return -1;
                        if (b === homeZoneId) return 1;
                        if (!this.allZones[a] || !this.allZones[b]) return 0;
                        return this.allZones[a].name.localeCompare(this.allZones[b].name);
                    });
                }
            }
            
            window.app = new BooleanToolboxApp();
        });
    </script>
</body>
</html>