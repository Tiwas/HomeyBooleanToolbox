<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Device Editor (API) - Boolean Toolbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.athom.com/homey-api/3.14.8.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1a202c; }
        .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; }
        .slide-enter-from, .slide-leave-to { opacity: 0; transform: translateY(-20px); }
        .list-move { transition: transform 0.5s; }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #edf2f7; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        /* Simulation Active State */
        .active-simulation-card {
            background-color: #eff6ff !important; /* blue-50 */
            border-color: #3b82f6 !important; /* blue-500 */
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
            transform: scale(1.01);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .cap-arrow {
            animation: pulse-arrow 1s infinite;
        }
        
        @keyframes pulse-arrow {
            0%, 100% { transform: translateX(0); opacity: 1; }
            50% { transform: translateX(5px); opacity: 0.7; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="app" class="flex-grow flex flex-col">
        <!-- Navbar -->
        <nav class="bg-white shadow sticky top-0 z-50 border-b border-gray-200">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="../README.md" class="text-xl font-bold text-purple-600 hover:text-purple-700">Boolean Toolbox</a>
                    <span class="text-gray-300">|</span>
                    <span class="text-gray-700 font-semibold">State Editor (API)</span>
                </div>
                <div class="space-x-3">
                    <button @click="showImportModal = true" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm transition shadow-sm">
                        <i class="fas fa-file-import mr-2"></i>Import / Merge
                    </button>
                    <button @click="copyToClipboard" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm transition shadow-sm">
                        <i class="fas fa-copy mr-2"></i>Copy JSON
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-6 flex-grow flex flex-col md:flex-row gap-6">
            
            <!-- Left Column: Configuration & Visual Editor -->
            <div class="w-full md:w-2/3 space-y-6">
                
                <!-- API Configuration Card -->
                <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4 cursor-pointer" @click="showApiConfig = !showApiConfig">
                        <h2 class="text-lg font-semibold text-purple-600"><i class="fas fa-network-wired mr-2"></i>Homey API Connection</h2>
                        <i class="fas text-gray-400" :class="showApiConfig ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                    </div>
                    <div v-if="showApiConfig" class="flex flex-col gap-4">
                        
                        <!-- State 1: Setup Credentials -->
                        <div v-if="!hasCredentials">
                            <p class="text-sm text-gray-600 mb-3">To connect, you need a Client ID and Client Secret. <a href="https://tools.developer.homey.app/tools/api-playground" target="_blank" class="text-blue-500 hover:underline">Create one here</a> (or use an existing one).</p>
                            <div class="grid grid-cols-1 gap-3">
                                <input type="text" v-model="clientId" placeholder="Client ID" class="bg-gray-50 border border-gray-300 rounded px-3 py-2 text-sm focus:border-purple-500 focus:outline-none">
                                <input type="password" v-model="clientSecret" placeholder="Client Secret" class="bg-gray-50 border border-gray-300 rounded px-3 py-2 text-sm focus:border-purple-500 focus:outline-none">
                                <button @click="saveCredentials" :disabled="!clientId || !clientSecret" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded text-sm font-semibold transition shadow-sm disabled:opacity-50">
                                    Save Credentials
                                </button>
                            </div>
                        </div>

                        <!-- State 2: Login -->
                        <div v-else-if="!isLoggedIn">
                            <div class="flex flex-col items-start gap-3">
                                <button @click="login" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded text-sm font-semibold transition shadow-sm flex items-center">
                                    <i class="fas fa-sign-in-alt mr-2"></i> Log in with Homey
                                </button>
                                <button @click="resetCredentials" class="text-xs text-gray-400 hover:text-gray-600 underline">Change Client ID/Secret</button>
                            </div>
                        </div>

                        <!-- State 3: Connected -->
                        <div v-else class="flex flex-col gap-3">
                            <div class="flex justify-between items-center bg-green-50 p-3 rounded border border-green-100">
                                <div class="flex items-center gap-3">
                                    <div v-if="userAvatar" class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden">
                                        <img :src="userAvatar" alt="User" class="w-full h-full object-cover">
                                    </div>
                                    <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold" v-else>
                                        {{ userName.charAt(0) }}
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-semibold text-gray-800">Connected as {{ userName }}</span>
                                        <span class="text-xs text-green-600">Authenticated</span>
                                    </div>
                                </div>
                                <button @click="logout" class="text-red-400 hover:text-red-600 text-xs font-medium">Logout</button>
                            </div>

                            <div class="flex gap-2 mt-2">
                                <button @click="fetchDevices" :disabled="isFetching" class="flex-grow bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:text-gray-500 text-white px-4 py-2 rounded text-sm font-semibold transition shadow-sm">
                                    <i class="fas" :class="isFetching ? 'fa-spinner fa-spin' : 'fa-sync'"></i> Fetch Devices
                                </button>
                            </div>
                        </div>

                        <!-- Status Messages -->
                        <div v-if="apiMessage" :class="apiError ? 'text-red-500' : 'text-green-500'" class="text-sm font-medium mt-2">
                            <i class="fas" :class="apiError ? 'fa-exclamation-circle' : 'fa-check-circle'"></i> {{ apiMessage }}
                        </div>
                    </div>
                </div>

                <!-- Global Config Card -->
                <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4 cursor-pointer" @click="toggleConfig">
                        <h2 class="text-lg font-semibold text-purple-600"><i class="fas fa-cogs mr-2"></i>Global Configuration</h2>
                        <i class="fas text-gray-400" :class="showConfig ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                    </div>
                    <div v-if="showConfig" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 uppercase mb-1">Default Delay (ms)</label>
                            <input type="number" v-model.number="config.default_delay" class="w-full bg-gray-50 border border-gray-300 rounded px-3 py-2 text-sm focus:border-purple-500 focus:ring-1 focus:ring-purple-500 focus:outline-none text-gray-900">
                        </div>
                        <div class="flex items-center mt-6">
                            <input type="checkbox" v-model="config.ignore_errors" id="ignore_errors" class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                            <label for="ignore_errors" class="ml-2 text-sm text-gray-700">Ignore Errors (Continue sequence)</label>
                        </div>
                        <div class="flex items-center mt-6">
                            <input type="checkbox" v-model="config.debug" id="debug" class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                            <label for="debug" class="ml-2 text-sm text-gray-700">Debug Mode</label>
                        </div>
                    </div>
                </div>

                <!-- Zones & Items Editor -->
                <div v-if="Object.keys(zones).length === 0" class="text-center py-12 bg-white rounded-lg border-2 border-dashed border-gray-300 shadow-sm">
                    <div class="mb-4">
                        <i class="fas fa-file-code text-5xl text-gray-300"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Configuration Loaded</h3>
                    <p class="text-gray-500 mb-6">Import a JSON configuration or load a device from Homey to get started.</p>
                    <button @click="showImportModal = true" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold shadow-md transition transform hover:scale-105">
                        <i class="fas fa-file-import mr-2"></i>Read JSON
                    </button>
                </div>

                <div v-else class="space-y-4">
                    <div v-for="(zone, zoneName) in zones" :key="zoneName" class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                        <!-- Zone Header -->
                        <div class="bg-gray-50 p-3 flex justify-between items-center border-b border-gray-200">
                            <div class="flex items-center space-x-3">
                                <span class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded border border-purple-200">ZONE</span>
                                <input v-model="zoneNameKeys[zoneName]" @change="renameZone(zoneName, $event.target.value)" class="bg-transparent border-b border-transparent hover:border-gray-300 focus:border-purple-500 focus:outline-none font-semibold text-lg w-48 text-gray-800" />
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-xs text-gray-500 mr-2">Zone Delay:</label>
                                <input type="number" v-model.number="zone.config.delay_between" class="w-20 bg-white border border-gray-300 rounded px-2 py-1 text-xs text-center text-gray-700 focus:border-purple-500 focus:outline-none">
                                <button @click="deleteZone(zoneName)" class="text-red-400 hover:text-red-600 px-2 transition"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>

                        <!-- Items List -->
                        <div class="p-4 space-y-3 min-h-[50px] bg-gray-50/50" @dragover.prevent @drop="onDropItem($event, zoneName)">
                            <div v-if="(!zone.items || zone.items.length === 0)" class="text-center text-gray-400 py-6 border-2 border-dashed border-gray-300 rounded bg-white">
                                No devices in this zone. Drag devices here or add new.
                            </div>
                            
                            <!-- ITEM CARD -->
                            <div v-for="(item, index) in zone.items" :key="item.id + index" 
                                 v-show="showInactive || item.active"
                                 :id="'card-' + getItemDomId(zoneName, index)"
                                 class="bg-white rounded border border-gray-200 p-3 shadow-sm hover:border-purple-300 hover:shadow-md transition relative group"
                                 :class="{'active-simulation-card': simulationState.currentItem === item}"
                                 draggable="true"
                                 @dragstart="onDragStart($event, zoneName, index)"
                                 @dragend="onDragEnd"
                                 @dragover.prevent
                                 @drop.stop="onDropItem($event, zoneName, index)">
                                
                                <!-- Drag Handle & Header -->
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex flex-col flex-grow mr-4">
                                        <div class="flex items-center space-x-2 cursor-move mb-1">
                                            <i class="fas fa-grip-vertical text-gray-400 group-hover:text-gray-600"></i>
                                            <input type="text" v-model="item.name" class="font-medium text-gray-800 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none w-full" placeholder="Device Name">
                                            <span v-if="!item.active" class="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded border border-red-200 font-medium whitespace-nowrap">INACTIVE</span>
                                        </div>
                                    </div>

                                    <div class="flex items-center space-x-1">
                                        <div class="flex flex-col space-y-0.5 mr-2">
                                            <button @click="moveItem(zoneName, index, -1)" :disabled="index === 0" class="text-gray-400 hover:text-gray-700 disabled:opacity-20 text-xs"><i class="fas fa-chevron-up"></i></button>
                                            <button @click="moveItem(zoneName, index, 1)" :disabled="index === zone.items.length - 1" class="text-gray-400 hover:text-gray-700 disabled:opacity-20 text-xs"><i class="fas fa-chevron-down"></i></button>
                                        </div>
                                        <button @click="item.active = !item.active" class="text-xs px-2 py-1 rounded border transition" :class="item.active ? 'bg-gray-100 text-gray-600 hover:bg-gray-200' : 'bg-green-100 text-green-700 border-green-200 hover:bg-green-200'">
                                            {{ item.active ? 'Disable' : 'Enable' }}
                                        </button>
                                        <button @click="removeItem(zoneName, index)" class="text-red-300 hover:text-red-500 ml-1"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>

                                <!-- Delay / Pause Config -->
                                <div class="flex items-center space-x-2 mb-3 bg-yellow-50 p-2 rounded border border-yellow-100">
                                    <i class="fas fa-hourglass-half text-yellow-500 text-xs"></i>
                                    <label class="text-xs text-gray-600">Wait before this:</label>
                                    <input type="number" v-model.number="item.delay" placeholder="Default" class="w-20 bg-white border border-gray-300 rounded px-2 py-1 text-xs text-gray-700 focus:border-yellow-500 focus:outline-none">
                                    <span class="text-xs text-gray-500">ms</span>
                                    <button @click="item.delay = (item.delay || 0) + 1000" class="text-xs bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-2 py-1 rounded ml-2 shadow-sm">+1s Pause</button>
                                </div>

                                <!-- Capabilities List -->
                                <div class="space-y-2 pl-4 border-l-2 border-gray-200 relative">
                                    <div v-for="(cap, cIndex) in item.capabilities" :key="cIndex" class="flex items-center space-x-2 text-sm relative">
                                        
                                        <!-- Simulation Arrow Indicator -->
                                        <div v-if="simulationState.currentCapability === cap" class="absolute -left-8 text-red-500 text-lg cap-arrow">
                                            <i class="fas fa-hand-point-right"></i>
                                        </div>

                                        <!-- Reorder Capabilities -->
                                        <div class="flex flex-col space-y-0.5 mr-1">
                                            <button @click="moveCapability(item, cIndex, -1)" :disabled="cIndex === 0" class="text-gray-300 hover:text-blue-600 disabled:opacity-0 text-[10px]"><i class="fas fa-caret-up"></i></button>
                                            <button @click="moveCapability(item, cIndex, 1)" :disabled="cIndex === item.capabilities.length - 1" class="text-gray-300 hover:text-blue-600 disabled:opacity-0 text-[10px]"><i class="fas fa-caret-down"></i></button>
                                        </div>

                                        <input type="text" v-model="cap.capability" class="w-1/3 bg-transparent border-b border-gray-300 text-blue-600 text-xs font-mono focus:border-blue-500 focus:outline-none" placeholder="Capability ID">
                                        <span class="text-gray-400">=</span>
                                        
                                        <!-- Value Input -->
                                        <input v-if="cap.capability === 'onoff'" type="checkbox" v-model="cap.value" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <input v-else-if="typeof cap.value === 'number'" type="number" step="0.01" v-model.number="cap.value" class="flex-1 bg-gray-50 border border-gray-300 rounded px-2 py-0.5 text-xs text-gray-800 focus:border-blue-500 focus:outline-none">
                                        <input v-else type="text" v-model="cap.value" class="flex-1 bg-gray-50 border border-gray-300 rounded px-2 py-0.5 text-xs text-gray-800 focus:border-blue-500 focus:outline-none">
                                        
                                        <button @click="removeCapability(item, cIndex)" class="text-gray-400 hover:text-red-500 ml-1"><i class="fas fa-minus-circle"></i></button>
                                    </div>
                                    <button @click="addCapability(item)" class="text-xs text-blue-600 hover:text-blue-800 mt-1 font-medium ml-5"><i class="fas fa-plus mr-1"></i> Add Capability</button>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <!-- Right Column: JSON & Simulation -->
            <div class="w-full md:w-1/3 space-y-6">
                
                <!-- Simulation Card -->
                <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm sticky top-24">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-play-circle mr-2 text-green-500"></i> Simulator
                    </h2>
                    
                    <div class="flex space-x-2 mb-4">
                        <button @click="startSimulation" :disabled="simulationState.running" class="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-200 disabled:text-gray-400 text-white py-2 rounded font-semibold transition shadow-sm">
                            <i class="fas fa-play mr-2"></i>Play
                        </button>
                        <button @click="stopSimulation" :disabled="!simulationState.running" class="flex-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-200 disabled:text-gray-400 text-white py-2 rounded font-semibold transition shadow-sm">
                            <i class="fas fa-stop mr-2"></i>Stop
                        </button>
                    </div>

                    <!-- Progress Log -->
                    <div class="bg-gray-900 rounded p-3 h-48 overflow-y-auto font-mono text-xs border border-gray-700 shadow-inner" id="sim-log">
                        <div v-if="simulationState.logs.length === 0" class="text-gray-500 italic">Ready to simulate...</div>
                        <div v-for="(log, i) in simulationState.logs" :key="i" :class="log.type === 'error' ? 'text-red-400' : (log.type === 'wait' ? 'text-yellow-400' : 'text-green-400')">
                            <span class="text-gray-500">[{{ log.time }}]</span> {{ log.msg }}
                        </div>
                    </div>
                </div>

                <!-- Status / Validation -->
                <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2"><i class="fas fa-check-circle mr-2 text-blue-500"></i>Validation</h2>
                    
                    <div v-if="Object.keys(zones).length === 0" class="text-gray-500 flex items-center font-medium">
                        <i class="fas fa-info-circle mr-2"></i> Waiting for Import
                    </div>
                    <div v-else class="text-green-600 flex items-center font-medium">
                        <i class="fas fa-check mr-2"></i> Valid Configuration
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-2">Import a JSON configuration to validate and edit.</p>
                </div>

            </div>
        </div>

        <!-- Import Modal -->
        <div v-if="showImportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                    <h2 class="text-xl font-bold text-gray-800">Import JSON</h2>
                    <button @click="showImportModal = false" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-lg"></i></button>
                </div>
                <div class="p-4 flex-grow flex flex-col">
                    <p class="text-sm text-gray-600 mb-2">Paste your existing JSON configuration or a new one to merge.</p>
                    <textarea v-model="importText" class="w-full flex-grow bg-gray-50 border border-gray-300 rounded p-3 font-mono text-xs text-gray-800 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none min-h-[200px]" placeholder='{ "zones": { ... } }'></textarea>
                    
                    <div v-if="importError" class="mt-2 text-red-600 text-sm bg-red-50 p-2 rounded border border-red-200">
                        <i class="fas fa-exclamation-circle mr-1"></i> {{ importError }}
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200 flex justify-end space-x-3 bg-gray-50 rounded-b-lg">
                    <template v-if="Object.keys(zones).length === 0">
                        <button @click="processImport('replace')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded text-sm font-semibold shadow-sm transition">
                            Import
                        </button>
                    </template>
                    <template v-else>
                        <button @click="processImport('merge_keep')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm shadow-sm transition">
                            Merge (Keep Existing)
                        </button>
                        <button @click="processImport('merge_overwrite')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded text-sm shadow-sm transition">
                            Merge (Overwrite)
                        </button>
                        <button @click="processImport('replace')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm shadow-sm transition">
                            Replace All
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Homey Selection Modal -->
        <div v-if="showHomeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full flex flex-col">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                    <h2 class="text-xl font-bold text-gray-800">Select Homey</h2>
                    <button @click="showHomeyModal = false; isFetching = false" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-lg"></i></button>
                </div>
                <div class="p-2 flex-grow overflow-y-auto max-h-[60vh]">
                    <div v-for="homey in homeys" :key="homey.id" @click="selectHomey(homey)" class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0 flex items-center gap-3 transition">
                        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">
                            <i class="fas fa-home"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-900">{{ homey.name }}</div>
                            <div class="text-xs text-gray-500">{{ homey.role }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Selection Modal -->
        <div v-if="showDeviceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-bold text-gray-800">Select State Device</h2>
                        <button @click="showDeviceModal = false; isFetching = false" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-lg"></i></button>
                    </div>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" v-model="deviceSearchQuery" placeholder="Search devices by name or zone..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                    </div>
                </div>
                <div class="p-4 flex-grow overflow-y-auto">
                    <div v-if="filteredDevices.length === 0" class="text-center text-gray-500 py-8">
                        No matching State Devices found.
                    </div>
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div v-for="device in filteredDevices" :key="device.id" @click="selectDevice(device)" class="border border-gray-200 rounded-lg p-3 hover:border-blue-500 hover:bg-blue-50 cursor-pointer transition shadow-sm">
                            <div class="font-semibold text-gray-900">{{ device.name }}</div>
                            <div class="text-xs text-gray-500 mt-1">{{ device.zoneName || 'Unknown Zone' }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <button @click="showInactive = !showInactive"
                class="fixed bottom-8 right-8 bg-purple-600 hover:bg-purple-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-xl transition transform hover:scale-110 z-40"
                :title="showInactive ? 'Hide Inactive Devices' : 'Show Inactive Devices'">
            <i class="fas" :class="showInactive ? 'fa-eye-slash' : 'fa-eye'"></i>
        </button>

    </div>

    <script>
        const { createApp, ref, computed, reactive, watch, nextTick } = Vue;

        createApp({
            setup() {
                // Global Config
                const config = ref({
                    default_delay: 200,
                    ignore_errors: true,
                    debug: false
                });
                
                // Editor State
                const zones = ref({});
                const zoneNameKeys = ref({});
                const showConfig = ref(true);
                const showInactive = ref(true);
                const showImportModal = ref(false);
                const showApiConfig = ref(true);
                const showHomeyModal = ref(false);
                const showDeviceModal = ref(false);
                const importText = ref('');
                const importError = ref(null);

                // Auth State
                const clientId = ref('');
                const clientSecret = ref('');
                const hasCredentials = ref(false);
                const isLoggedIn = ref(false);
                const userName = ref('');
                const userAvatar = ref('');
                
                // API State
                const isFetching = ref(false);
                const apiMessage = ref('');
                const apiError = ref(false);
                const homeys = ref([]);
                const homeyDevices = ref([]);
                const selectedHomey = ref(null);
                
                const deviceSearchQuery = ref('');
                let cloudApi = null;

                // --- Auth Logic ---

                const saveCredentials = () => {
                    if (clientId.value && clientSecret.value) {
                        localStorage.setItem('homey_client_id', clientId.value);
                        localStorage.setItem('homey_client_secret', clientSecret.value);
                        hasCredentials.value = true;
                        // Reload to init fresh
                        window.location.reload();
                    }
                };

                const resetCredentials = () => {
                    if (confirm("Remove Client ID and Secret? You will be logged out.")) {
                        localStorage.removeItem('homey_client_id');
                        localStorage.removeItem('homey_client_secret');
                        clientId.value = '';
                        clientSecret.value = '';
                        hasCredentials.value = false;
                        logout();
                    }
                };

                const login = () => {
                    if (!cloudApi) return;
                    const authUrl = cloudApi.getLoginUrl({
                        // Try full 'homey' scope to resolve visibility issues
                        scopes: ['homey', 'homey.device.control'], 
                        state: 'random_state_string' // Simple state
                    });
                    window.location.href = authUrl;
                };

                const postLogin = async () => {
                    try {
                        const user = await cloudApi.getAuthenticatedUser();
                        userName.value = user.firstname + ' ' + user.lastname;
                        // Handle avatar object or string
                        if (user.avatar && typeof user.avatar === 'object') {
                            userAvatar.value = user.avatar.small || user.avatar.medium || user.avatar.url;
                        } else {
                            userAvatar.value = user.avatar;
                        }
                        isLoggedIn.value = true;
                        apiMessage.value = "Connected!";
                        apiError.value = false;
                    } catch (e) {
                        console.error("Post Login Error:", e);
                        apiError.value = true;
                        apiMessage.value = "Login verification failed.";
                    }
                };

                const logout = async () => {
                    if (cloudApi) await cloudApi.logout();
                    isLoggedIn.value = false;
                    userName.value = '';
                    userAvatar.value = '';
                    apiMessage.value = '';
                };


                // --- API Logic ---

                const filteredDevices = computed(() => {
                    if (!deviceSearchQuery.value) return homeyDevices.value;
                    const lower = deviceSearchQuery.value.toLowerCase();
                    return homeyDevices.value.filter(d => 
                        d.name.toLowerCase().includes(lower) || 
                        (d.zoneName && d.zoneName.toLowerCase().includes(lower))
                    );
                });

                const fetchDevices = async () => {
                    if (!cloudApi || !isLoggedIn.value) return;
                    isFetching.value = true;
                    apiMessage.value = 'Fetching Homeys...';
                    apiError.value = false;
                    
                    try {
                        const user = await cloudApi.getAuthenticatedUser();
                        console.log("CloudAPI object:", cloudApi); // INSPECT THIS
                        console.log("User object:", user);
                        
                        let homeyList = [];
                        try {
                             homeyList = await user.getHomeys();
                             console.log("user.getHomeys() returned:", homeyList);
                        } catch (err) {
                            console.warn("user.getHomeys() failed:", err);
                        }

                        // Fallback 1: Check properties
                        if (!homeyList || homeyList.length === 0) {
                             if (user.homeys && Array.isArray(user.homeys)) {
                                 console.log("Found user.homeys property:", user.homeys);
                                 homeyList = user.homeys;
                             }
                        }

                        // Fallback 2: Raw API Call (Manual Fetch)
                        if (!homeyList || homeyList.length === 0) {
                            console.log("Trying fallback API call to manual fetch...");
                            try {
                                // Try to extract token from cloudApi internals
                                // Inspecting possible locations for the token
                                const tokenObj = cloudApi.token || cloudApi.__token || (cloudApi.getToken && cloudApi.getToken()) || (cloudApi._token);
                                const accessToken = tokenObj ? (tokenObj.access_token || tokenObj.accessToken) : null;
                                
                                console.log("Extracted access token:", accessToken ? "Yes (hidden)" : "No");

                                if (accessToken) {
                                    let url = 'https://api.athom.com/user/me/homeys';
                                    if (user && user._id) {
                                        url = `https://api.athom.com/user/${user._id}/homeys`;
                                    }
                                    
                                    console.log("Fetching homeys from:", url);
                                    let res = await fetch(url, {
                                        headers: { 'Authorization': `Bearer ${accessToken}` }
                                    });

                                    // If 404, try legacy endpoint
                                    if (res.status === 404) {
                                        console.warn("Primary endpoint 404, trying legacy: /api/manager/users/user/me/homeys");
                                        url = 'https://api.athom.com/api/manager/users/user/me/homeys';
                                        res = await fetch(url, {
                                            headers: { 'Authorization': `Bearer ${accessToken}` }
                                        });
                                    }
                                    
                                    if (res.ok) {
                                        const rawRes = await res.json();
                                        console.log("Manual fetch response:", rawRes);
                                        if (Array.isArray(rawRes)) homeyList = rawRes;
                                    } else {
                                        console.warn("Manual fetch failed:", res.status, res.statusText);
                                    }
                                } else {
                                    console.warn("Could not find access token in cloudApi object.");
                                }
                            } catch (err) {
                                console.error("Fallback API call failed:", err);
                            }
                        }

                        if (!homeyList || homeyList.length === 0) {
                            throw new Error('No Homeys found. Check console for details.');
                        }

                        homeys.value = homeyList;

                        if (homeyList.length > 1) {
                            apiMessage.value = 'Select a Homey...';
                            showHomeyModal.value = true;
                        } else {
                            selectHomey(homeyList[0]);
                        }
                        
                    } catch (e) {
                        apiError.value = true;
                        apiMessage.value = "Fetch failed: " + e.message;
                        isFetching.value = false;
                    }
                };

                const selectHomey = async (homey) => {
                    selectedHomey.value = homey;
                    showHomeyModal.value = false;
                    apiMessage.value = `Connecting to ${homey.name}...`;
                    
                    try {
                        // Connect to Homey API for this specific Homey
                        // The AthomCloudAPI handles the routing/tunneling
                        const devices = await homey.devices.getDevices();
                        const devicesArray = Object.values(devices);
                        
                        // Filter for State Devices
                        homeyDevices.value = devicesArray.filter(d => 
                            (d.driverUri && d.driverUri.includes('state-device')) ||
                            (d.driverId && d.driverId === 'state-device')
                        ).map(d => ({
                            id: d.id,
                            name: d.name,
                            zoneName: d.zoneName || 'Unknown', 
                            settings: d.settings
                        }));

                        apiMessage.value = `Found ${homeyDevices.value.length} State Devices.`;
                        showDeviceModal.value = true;
                        isFetching.value = false;

                    } catch (e) {
                        apiError.value = true;
                        console.error(e);
                        apiMessage.value = "Failed to fetch devices: " + e.message;
                        isFetching.value = false;
                    }
                };

                const selectDevice = (device) => {
                    if (device.settings && device.settings.json_data) {
                        importText.value = device.settings.json_data;
                        try {
                            processImport('replace');
                            showDeviceModal.value = false;
                            apiMessage.value = `Loaded: ${device.name}`;
                        } catch(e) {
                            alert("Error loading device config: " + e.message);
                        }
                    } else {
                        alert("This device has no configuration data.");
                    }
                };

                // --- Standard Logic (unchanged) ---

                // Simulation State
                const simulationState = reactive({
                    running: false,
                    currentItem: null,
                    currentCapability: null,
                    logs: []
                });

                // Validation
                const isValid = computed(() => {
                    return Object.keys(zones.value).length > 0;
                });

                // Helper for DOM IDs
                const getItemDomId = (zoneName, index) => {
                     return zoneName.replace(/\s+/g, '-') + '-' + index;
                };

                // Actions
                const toggleConfig = () => showConfig.value = !showConfig.value;

                const addZone = () => {
                    let name = "Zone " + (Object.keys(zones.value).length + 1);
                    zones.value[name] = { config: { delay_between: 500 }, items: [] };
                    zoneNameKeys.value[name] = name;
                };

                const renameZone = (oldName, newName) => {
                    if (oldName === newName) return;
                    if (zones.value[newName]) {
                        alert('Zone name already exists!');
                        zoneNameKeys.value[oldName] = oldName; 
                        return;
                    }
                    const content = zones.value[oldName];
                    delete zones.value[oldName];
                    zones.value[newName] = content;
                    delete zoneNameKeys.value[oldName];
                    zoneNameKeys.value[newName] = newName;
                };

                const deleteZone = (name) => {
                    if (confirm(`Delete zone "${name}"?`)) {
                        delete zones.value[name];
                        delete zoneNameKeys.value[name];
                    }
                };

                const removeItem = (zoneName, index) => {
                    zones.value[zoneName].items.splice(index, 1);
                };

                const moveItem = (zoneName, index, direction) => {
                    const items = zones.value[zoneName].items;
                    const newIndex = index + direction;
                    if (newIndex >= 0 && newIndex < items.length) {
                        const temp = items[index];
                        items[index] = items[newIndex];
                        items[newIndex] = temp;
                    }
                };

                const addCapability = (item) => {
                    item.capabilities.push({ capability: "", value: "" });
                };

                const removeCapability = (item, index) => {
                    item.capabilities.splice(index, 1);
                };
                
                const moveCapability = (item, index, direction) => {
                    const caps = item.capabilities;
                    const newIndex = index + direction;
                    if (newIndex >= 0 && newIndex < caps.length) {
                        const temp = caps[index];
                        caps[index] = caps[newIndex];
                        caps[newIndex] = temp;
                    }
                };

                // Drag and Drop Logic
                const dragSource = ref(null);

                const onDragStart = (evt, zoneName, index) => {
                    dragSource.value = { zone: zoneName, index: index };
                    evt.dataTransfer.effectAllowed = 'move';
                    evt.target.style.opacity = '0.5';
                };

                const onDragEnd = (evt) => {
                    evt.target.style.opacity = '1';
                    dragSource.value = null;
                };

                const onDropItem = (evt, targetZone, targetIndex = null) => {
                    const src = dragSource.value;
                    if (!src) return;
                    
                    const item = zones.value[src.zone].items.splice(src.index, 1)[0];
                    
                    if (targetIndex === null) {
                        zones.value[targetZone].items.push(item);
                    } else {
                        zones.value[targetZone].items.splice(targetIndex, 0, item);
                    }
                };


                // Import Logic
                const processImport = (mode) => {
                    importError.value = null;
                    try {
                        const data = JSON.parse(importText.value);
                        let importedZones = {};
                        let importedConfig = data.config || {};

                        if (data.zones) {
                            importedZones = data.zones;
                        } else if (data.items) {
                            importedZones["Default Zone"] = {
                                config: {},
                                items: data.items
                            };
                        } else {
                            throw new Error("Invalid JSON: No 'zones' or 'items' found.");
                        }

                        if (mode === 'replace') {
                            config.value = { ...config.value, ...importedConfig };
                            zones.value = importedZones;
                            zoneNameKeys.value = {};
                            Object.keys(zones.value).forEach(k => zoneNameKeys.value[k] = k);
                        } else {
                            if (importedConfig) {
                                config.value = { ...config.value, ...importedConfig };
                            }
                            
                            for (const [zName, zData] of Object.entries(importedZones)) {
                                if (!zones.value[zName]) {
                                    zones.value[zName] = zData;
                                    zoneNameKeys.value[zName] = zName;
                                } else {
                                    const existingItemsMap = new Map();
                                    zones.value[zName].items.forEach((item, idx) => {
                                        if(item.id) existingItemsMap.set(item.id, idx);
                                    });

                                    for (const newItem of zData.items) {
                                        if (newItem.id && existingItemsMap.has(newItem.id)) {
                                            if (mode === 'merge_overwrite') {
                                                const idx = existingItemsMap.get(newItem.id);
                                                zones.value[zName].items[idx] = newItem;
                                            }
                                        } else {
                                            zones.value[zName].items.push(newItem);
                                        }
                                    }
                                }
                            }
                        }
                        showImportModal.value = false;
                        importText.value = '';
                    } catch (e) {
                        importError.value = e.message;
                        // Re-throw to alert caller if needed
                        throw e;
                    }
                };

                // Export Logic
                const generatedJson = computed(() => {
                    return JSON.stringify({
                        _meta: {
                            editor: "https://tiwas.github.io/HomeyBooleanToolbox/docs/state-editor.html",
                            documentation: "https://tiwas.github.io/HomeyBooleanToolbox/docs/state-device.html"
                        },
                        config: config.value,
                        zones: zones.value
                    }, null, 2);
                });

                const copyToClipboard = () => {
                    navigator.clipboard.writeText(generatedJson.value).then(() => {
                        alert("JSON copied to clipboard!");
                    });
                };

                // Simulator Logic
                const addLog = (msg, type='info') => {
                    const time = new Date().toLocaleTimeString().split(' ')[0];
                    simulationState.logs.unshift({ time, msg, type });
                };

                const sleep = (ms) => new Promise(r => setTimeout(r, ms));
                
                const scrollToElement = (elementId) => {
                    const el = document.getElementById(elementId);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                };

                const startSimulation = async () => {
                    if (simulationState.running) return;
                    simulationState.running = true;
                    simulationState.logs = [];
                    addLog("Starting simulation...");

                    const globalDelay = config.value.default_delay || 200;
                    
                    for (const [zoneName, zoneData] of Object.entries(zones.value)) {
                        if (!simulationState.running) break;

                        const zoneDelay = zoneData.config?.delay_between ?? globalDelay;
                        addLog(`Entering Zone: ${zoneName}`, 'info');

                        let itemIndex = 0;
                        for (const item of zoneData.items) {
                            if (!simulationState.running) break;
                            if (!item.active) {
                                addLog(`Skipping inactive: ${item.name}`, 'info');
                                itemIndex++;
                                continue;
                            }
                            
                            // Highlight & Scroll
                            simulationState.currentItem = item;
                            scrollToElement('card-' + getItemDomId(zoneName, itemIndex));
                            
                            // Delay
                            let delay = item.delay;
                            if (delay === undefined || delay === null || delay === "") delay = zoneDelay;
                            
                            if (delay > 0) {
                                addLog(`Waiting ${delay}ms...`, 'wait');
                                await sleep(delay);
                            }

                            // Execute
                            addLog(`Executing: ${item.name}`, 'success');
                            
                            if (item.capabilities && item.capabilities.length > 0) {
                                for(let cap of item.capabilities) {
                                    if (!simulationState.running) break;
                                    
                                    simulationState.currentCapability = cap;
                                    addLog(` -> Set ${cap.capability} = ${cap.value}`, 'info');
                                    await sleep(800); // Visual delay to see the arrow
                                }
                                simulationState.currentCapability = null;
                            } else {
                                addLog(` -> No capabilities (Pause only?)`, 'wait');
                            }
                            
                            simulationState.currentItem = null;
                            itemIndex++;
                        }
                    }

                    addLog("Simulation completed.", 'success');
                    simulationState.running = false;
                    simulationState.currentItem = null;
                    simulationState.currentCapability = null;
                };

                const stopSimulation = () => {
                    simulationState.running = false;
                    simulationState.currentItem = null;
                    simulationState.currentCapability = null;
                    addLog("Simulation stopped by user.", 'error');
                };

                const initAuth = async () => {
                    const storedId = localStorage.getItem('homey_client_id');
                    const storedSecret = localStorage.getItem('homey_client_secret');

                    if (storedId && storedSecret) {
                        clientId.value = storedId;
                        clientSecret.value = storedSecret;
                        hasCredentials.value = true;
                        
                        try {
                            cloudApi = new AthomCloudAPI({
                                clientId: storedId,
                                clientSecret: storedSecret,
                                redirectUrl: window.location.href.split('?')[0] // Current page
                            });

                            // Check for auth code in URL
                            const urlParams = new URLSearchParams(window.location.search);
                            const code = urlParams.get('code');

                            if (code) {
                                apiMessage.value = "Completing login...";
                                try {
                                    await cloudApi.authenticateWithAuthorizationCode({ code });
                                    // Clean URL only after success
                                    window.history.replaceState({}, document.title, window.location.pathname);
                                    await postLogin();
                                } catch (err) {
                                    console.error("Auth Code Error:", err);
                                    // Try passing raw string if object failed
                                    if (err.message === "Missing Code") {
                                         await cloudApi.authenticateWithAuthorizationCode(code);
                                         window.history.replaceState({}, document.title, window.location.pathname);
                                         await postLogin();
                                    } else {
                                        throw err;
                                    }
                                }
                            } else if (await cloudApi.isLoggedIn()) {
                                await postLogin();
                            }
                        } catch (e) {
                            console.error("Auth Init Error:", e);
                            apiError.value = true;
                            apiMessage.value = "Auth Error: " + e.message;
                        }
                    }
                };
                
                // Init
                nextTick(() => {
                    initAuth();
                });

                return {
                    config, zones, zoneNameKeys,
                    showConfig, showInactive, showImportModal, showApiConfig, showHomeyModal, showDeviceModal, importText, importError,
                    
                    // Auth
                    clientId, clientSecret, hasCredentials, isLoggedIn, userName, userAvatar,
                    saveCredentials, resetCredentials, login, logout,
                    
                    // API
                    isFetching, apiMessage, apiError, homeys, homeyDevices, fetchDevices, selectHomey, selectDevice,
                    deviceSearchQuery, filteredDevices,
                    
                    simulationState, isValid, generatedJson, getItemDomId,
                    toggleConfig, addZone, renameZone, deleteZone,
                    addItem: () => {}, removeItem, moveItem,
                    addCapability, removeCapability, moveCapability,
                    onDragStart, onDragEnd, onDropItem,
                    processImport, copyToClipboard,
                    startSimulation, stopSimulation
                };
            }
        }).mount('#app');
    </script>
</body>
</html>