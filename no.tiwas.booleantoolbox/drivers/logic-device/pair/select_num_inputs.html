<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      text-align: center;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background-color: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      margin-bottom: 10px;
      color: #333;
    }
    .description {
      color: #666;
      margin: 20px 0 40px 0;
      line-height: 1.5;
    }
    .input-selector {
      margin: 40px auto;
    }
    .input-number {
      width: 120px;
      height: 80px;
      font-size: 32px;
      text-align: center;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      font-weight: bold;
      color: #4CAF50;
    }
    .input-number:focus {
      outline: none;
      border-color: #45a049;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    .range-info {
      margin-top: 15px;
      color: #888;
      font-size: 14px;
    }
    button {
      padding: 15px 40px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      margin-top: 40px;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 data-i18n="pair.select_inputs_title">Select number of inputs</h2>
    <p class="description" data-i18n="pair.select_inputs_description">How many devices do you want to connect to this logic device?</p>

    <div class="input-selector">
      <input type="number" id="numInputs" class="input-number" min="2" max="10" value="2">
      <div class="range-info" data-i18n="pair.inputs_range">Choose between 2 and 10 inputs</div>
    </div>

    <button id="continue-btn" data-i18n="pair.next">Next →</button>
  </div>

<script>
    const numInputsEl = document.getElementById('numInputs');
    let homeyRef; // Bør bli satt globalt av Homey-miljøet

    // Logger til nettleserkonsoll
    function logToConsole(message, data) {
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      const logMessage = `[VIEW][${timestamp}] ${message}`;
      console.log(logMessage, data || '');
    }

    // Funksjon for å bruke oversettelser
    function applyTranslations() {
        logToConsole('Attempting to apply translations...');
        try {
            // Sjekk om Homey.__ er tilgjengelig
            if (typeof Homey === 'undefined' || typeof Homey.__ !== 'function') {
                logToConsole('Homey.__ is not available yet.');
                return; // Avbryt hvis funksjonen ikke finnes
            }

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                try {
                    el.textContent = Homey.__(key);
                } catch (e) {
                   logToConsole(`Error translating key '${key}':`, e);
                   el.textContent = key; // Fallback
                }
            });
            logToConsole('Translations applied (or attempted).');
        } catch (e) {
            logToConsole('Error during translation loop:', e);
        }
    }

    // --- Kjør koden direkte ---
    logToConsole('Script tag started.');

    // Initialiseringslogikk
    async function init() {
      logToConsole('init() started.');
      try {
        // Anta at Homey.emit er tilgjengelig globalt
        logToConsole("Emitting 'get_num_inputs'...");
        const result = await Homey.emit('get_num_inputs');
        logToConsole("'get_num_inputs' received result:", result);
        numInputsEl.value = result.numInputs || 2;
        logToConsole(`Initial numInputs value set to: ${numInputsEl.value}`);
      } catch (e) {
        logToConsole("Error in init() during emit:", e);
        // Vis feil hvis alert er tilgjengelig
        if (typeof Homey !== 'undefined' && Homey.alert) {
             Homey.alert(Homey.__('pair.error_loading_initial_data', { error: (e.message || e) }), 'error');
        }
      }
      logToConsole('init() finished.');
    }

    // Event listeners
    try {
      logToConsole('Adding change listener for numInputs...');
      numInputsEl.addEventListener('change', async (e) => {
        logToConsole('numInputs change triggered.');
        let value = parseInt(e.target.value);
        if (isNaN(value) || value < 2) value = 2;
        if (value > 10) value = 10;
        e.target.value = value;
        logToConsole(`Input value validated: ${value}`);
        try {
          if (typeof Homey === 'undefined' || typeof Homey.emit !== 'function') {
             throw new Error(Homey.__('pair.error_homey_emit_unavailable'));
          }
          logToConsole(`Emitting 'set_num_inputs' with value: ${value}`);
          await Homey.emit('set_num_inputs', { numInputs: value });
          logToConsole("'set_num_inputs' emitted successfully.");
        } catch (e) {
          logToConsole('Error emitting set_num_inputs:', e);
           if (typeof Homey !== 'undefined' && Homey.alert) {
               Homey.alert(Homey.__('pair.error_saving_input_number', { error: (e.message || e) }), 'error');
           }
        }
      });
      logToConsole('numInputs listener added.');

      logToConsole('Adding click listener for continue-btn...');
      document.getElementById('continue-btn').addEventListener('click', () => {
        logToConsole('continue-btn clicked.');
        try {
          if (typeof Homey === 'undefined' || typeof Homey.nextView !== 'function') {
             throw new Error(Homey.__('pair.error_homey_nextview_unavailable'));
          }
          logToConsole('Calling Homey.nextView()...');
          Homey.nextView();
        } catch (e) {
          logToConsole('Error calling Homey.nextView():', e);
          if (typeof Homey !== 'undefined' && Homey.alert) {
             Homey.alert(Homey.__('pair.error_navigating', { error: (e.message || e) }), 'error');
          }
        }
      });
      logToConsole('continue-btn listener added.');

    } catch (e) {
       logToConsole('Error adding event listeners:', e);
       if (typeof Homey !== 'undefined' && Homey.alert) {
           Homey.alert(Homey.__('pair.error_setting_up_interactions', { error: (e.message || e) }), 'error');
       }
    }

    // Kall init umiddelbart
    init();

    // Forsøk å kjøre oversettelser etter en kort forsinkelse
    logToConsole('Scheduling translations check...');
    setTimeout(applyTranslations, 500); // Prøv etter 500ms

    logToConsole('Script tag finished.');
  </script>
</body>
</html>