<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: opacity 0.3s ease-in-out;
    }
    .fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .fade-in {
      opacity: 1;
    }
    h2 {
      margin-bottom: 10px;
      color: #333;
    }
    .description {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .input-config {
      margin-bottom: 25px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background-color: #fafafa;
      transition: all 0.3s ease;
    }
    .input-config.complete {
      border-color: #4CAF50;
      background-color: #f1f8f4;
    }
    .input-config h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 18px;
    }
    .input-config label {
      display: block;
      margin-top: 12px;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
      font-size: 14px;
    }
    select {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: white;
      transition: border-color 0.2s;
    }
    select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    select:disabled {
      background-color: #f5f5f5;
      cursor: not-allowed;
    }
    .status {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .status.complete {
      background-color: #4CAF50;
      color: white;
    }
    .status.incomplete {
      background-color: #ff9800;
      color: white;
    }
    .summary {
      margin-top: 30px;
      padding: 20px;
      background-color: #e3f2fd;
      border-radius: 8px;
      border-left: 4px solid #2196F3;
    }
    .summary strong {
      color: #1976D2;
    }
    .device-name-section {
      margin-top: 30px;
      padding: 20px;
      background-color: #fff3e0;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
    }
    .device-name-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .device-name-section input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .device-name-section input:focus {
      outline: none;
      border-color: #ff9800;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
      transition: opacity 0.3s ease;
    }
    .loading:before {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    button {
      padding: 15px 40px;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      width: 100%;
      margin-top: 20px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    button.btn-enabled {
      background-color: #4CAF50 !important;
      cursor: pointer !important;
      pointer-events: auto !important;
    }

    button.btn-disabled {
      background-color: #cccccc !important;
      cursor: not-allowed !important;
      pointer-events: none !important;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      background-color: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #c62828;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Configure inputs</h2>
    <p class="description">Select which device and capability each input should follow:</p>
    
    <div id="loading" class="loading">
      Loading devices...
    </div>
    
    <div id="inputs-container" style="display: none;"></div>

    <div id="device-name-section" class="device-name-section" style="display: none;">
      <label for="deviceName">Give the device a name:</label>
      <input type="text" id="deviceName" placeholder="E.g: Bedroom logic" value="Logic Device">
    </div>

    <div id="summary" class="summary" style="display: none;"></div>

    <div id="error-message" class="error" style="display: none;"></div>
    
    <button id="complete-btn">...</button>
  </div>

<script>
    document.getElementById('complete-btn').addEventListener('click', visVarsel);

    async function visVarsel() {
      try {
        const inputLinks = [];
        const deviceName = document.getElementById('deviceName').value || 'Logic Device';
        
        for (let i = 0; i < numInputs; i++) {
          const inputId = letters[i].toLowerCase();
          const deviceSelect = document.getElementById(`device-${inputId}`);
          const deviceId = deviceSelect?.value;
          const capability = document.getElementById(`capability-${inputId}`)?.value;
          
          if (deviceId && capability) {
            // Hent også device name fra selected option
            const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
            const deviceName = selectedOption?.text || 'Unknown Device';
            
            inputLinks.push({ 
              input: inputId, 
              deviceId, 
              capability,
              deviceName  // Lagre device name
            });
          }
        }
        
        if (inputLinks.length !== numInputs) {
          await Homey.alert('Please configure all inputs first!', 'warning');
          return;
        }
        
        await Homey.emit('set_input_links', { inputLinks });
        await Homey.emit('set_device_name', { name: deviceName });
        
        const deviceData = await Homey.emit('create_device');
        await Homey.createDevice(deviceData);
        
        await Homey.done();
        
      } catch (e) {
        console.error('Error:', e);
        await Homey.alert('Error: ' + e.message, 'error');
      }
    }

    let zones = [];
    let numInputs = 2;
    const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];

    function log(message, data) {
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      const logMessage = `[${timestamp}] ${message}`;
      console.log(logMessage, data || '');
    }

    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    async function init() {
      try {
        const numInputsResult = await Homey.emit('get_num_inputs');
        numInputs = numInputsResult.numInputs || 2;
        
        log('Fetching zones...');
        zones = await Homey.emit('get_zones');
        if (!zones || zones.length === 0) {
          showError('No zones found. Please create zones in your Homey first.');
          document.getElementById('loading').style.display = 'none';
          return;
        }
        log('Zones fetched successfully', zones.length);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('inputs-container').style.display = 'block';
        document.getElementById('device-name-section').style.display = 'block';
        document.getElementById('summary').style.display = 'block';
        
        renderInputs();
        
        setTimeout(() => {
          updateSummary();
        }, 100);
      } catch (e) {
        console.error('Init error:', e);
        showError('Error loading initial data: ' + e.message);
        document.getElementById('loading').style.display = 'none';
      }
    }

    function renderInputs() {
      const container = document.getElementById('inputs-container');
      container.innerHTML = '';
      
      let zoneOptions = '<option value="">-- Select zone/room --</option>';
      zones.forEach(zone => {
        zoneOptions += `<option value="${zone.id}">${zone.name}</option>`;
      });

      for (let i = 0; i < numInputs; i++) {
        const letter = letters[i];
        const inputId = letter.toLowerCase();

        const div = document.createElement('div');
        div.className = 'input-config';
        div.id = `input-config-${inputId}`;
        
        div.innerHTML = `
          <h3>Input ${letter}</h3>
          <label>Zone/Room:</label>
          <select id="zone-${inputId}" data-input="${inputId}">${zoneOptions}</select>
          <label>Device:</label>
          <select id="device-${inputId}" data-input="${inputId}" disabled><option value="">-- Select zone first --</option></select>
          <label>Capability:</label>
          <select id="capability-${inputId}" data-input="${inputId}" disabled><option value="">-- Select device first --</option></select>
          <div class="status incomplete" id="status-${inputId}">⚠️ Not configured</div>
        `;
        container.appendChild(div);

        document.getElementById(`zone-${inputId}`).addEventListener('change', (e) => onZoneChange(inputId, e.target.value));
        document.getElementById(`device-${inputId}`).addEventListener('change', (e) => onDeviceChange(inputId, e.target.value));
        document.getElementById(`capability-${inputId}`).addEventListener('change', updateSummary);
      }
    }

    async function onZoneChange(inputId, zoneId) {
      log(`Zone changed for input ${inputId}`, zoneId);
      const deviceSelect = document.getElementById(`device-${inputId}`);
      const capabilitySelect = document.getElementById(`capability-${inputId}`);
      
      deviceSelect.innerHTML = '<option value="">Loading devices...</option>';
      deviceSelect.disabled = true;
      capabilitySelect.innerHTML = '<option value="">-- Select device first --</option>';
      capabilitySelect.disabled = true;
      
      if (!zoneId) {
        deviceSelect.innerHTML = '<option value="">-- Select zone first --</option>';
        updateSummary();
        return;
      }

      try {
        const devicesInZone = await Homey.emit('get_devices_in_zone', { zoneId });
        log(`Found ${devicesInZone.length} devices in zone ${zoneId}`);
        
        deviceSelect.innerHTML = '<option value="">-- Select device --</option>';
        devicesInZone.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id;
          option.dataset.capabilities = JSON.stringify(d.capabilities);
          option.textContent = `${d.name} (${d.driverName})`;
          deviceSelect.appendChild(option);
        });
        deviceSelect.disabled = false;
      } catch (e) {
        showError(`Failed to load devices for zone: ${e.message}`);
        deviceSelect.innerHTML = '<option value="">-- Error loading --</option>';
      }
      
      updateSummary();
    }

    function onDeviceChange(inputId, deviceId) {
      log(`Device changed for input ${inputId}`, deviceId);
      const deviceSelect = document.getElementById(`device-${inputId}`);
      const capabilitySelect = document.getElementById(`capability-${inputId}`);
      
      capabilitySelect.innerHTML = '<option value="">-- Select capability --</option>';
      capabilitySelect.disabled = true;
      
      if (deviceId) {
        const selectedOption = deviceSelect.querySelector(`option[value="${deviceId}"]`);
        if (selectedOption && selectedOption.dataset.capabilities) {
          const capabilities = JSON.parse(selectedOption.dataset.capabilities);
          
          capabilities.forEach(cap => {
            const option = document.createElement('option');
            option.value = cap.id;
            option.textContent = `${cap.name} (${cap.id})`;
            capabilitySelect.appendChild(option);
          });
          capabilitySelect.disabled = false;
        }
      }
      
      updateSummary();
    }

    async function saveConfigToBackend() {
      const inputLinks = [];
      const deviceName = document.getElementById('deviceName').value || 'Logic Device';
      
      for (let i = 0; i < numInputs; i++) {
        const inputId = letters[i].toLowerCase();
        const deviceSelect = document.getElementById(`device-${inputId}`);
        const deviceId = deviceSelect?.value;
        const capability = document.getElementById(`capability-${inputId}`)?.value;
        
        if (deviceId && capability) {
          // Hent device name
          const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
          const deviceName = selectedOption?.text || 'Unknown Device';
          
          inputLinks.push({ 
            input: inputId, 
            deviceId, 
            capability,
            deviceName  // Inkluder device name
          });
        }
      }
      
      if (inputLinks.length === numInputs) {
        try {
          await Homey.emit('set_input_links', { inputLinks });
          await Homey.emit('set_device_name', { name: deviceName });
        } catch (e) {
          console.error('Error saving config:', e);
        }
      }
    }    

    function updateSummary() {
      let allConfigured = true;
      let configuredCount = 0;

      for (let i = 0; i < numInputs; i++) {
        const inputId = letters[i].toLowerCase();
        const deviceId = document.getElementById(`device-${inputId}`)?.value;
        const capability = document.getElementById(`capability-${inputId}`)?.value;
        const statusEl = document.getElementById(`status-${inputId}`);
        const configDiv = document.getElementById(`input-config-${inputId}`);
        
        if (deviceId && capability) {
          if (statusEl) {
            statusEl.className = 'status complete';
            statusEl.textContent = '✓ Configured';
          }
          if (configDiv) configDiv.classList.add('complete');
          configuredCount++;
        } else {
          if (statusEl) {
            statusEl.className = 'status incomplete';
            statusEl.textContent = '⚠️ Not configured';
          }
          if (configDiv) configDiv.classList.remove('complete');
          allConfigured = false;
        }
      }

      const summaryEl = document.getElementById('summary');
      if (summaryEl) {
        summaryEl.innerHTML = `<strong>Status:</strong> ${configuredCount} of ${numInputs} inputs configured`;
      }

      const btn = document.getElementById('complete-btn');
      if (allConfigured) {
        saveConfigToBackend();
        btn.innerHTML = "Save and complete"
        btn.className = "btn-enabled";
      } else {
        btn.innerHTML = "..."
        btn.className = "btn-disabled";
      }
    }

    init();
</script>
</body>
</html>